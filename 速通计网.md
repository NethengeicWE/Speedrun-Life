# 计算机网络速通
## 前言
* 坏消息：还是计网的那个老师
* 好消息：熟练多了
* 坏消息：这是她第二次讲这门课
* 好消息：教材也是一坨，现实的网络架构也是一坨
## C1：概述
* 较准确的定义：计算机网络主要是由一些通用的、可编程的硬件，互连而成的。硬件功能不单一，传递数据类型多样，支持广泛的日益增长的应用
* 互联网：
    * Internet：特指，由数量极大的各种计算机网络互连起来而形成的一个互连网络。它采用 TCP/IP 协议族作为通信规则，是一个覆盖全球、实现全球范围内连通性和资源共享的计算机网络
    * Internet：由多个计算机网络（简称网络）通过一些路由器相互连接起来，构成了一个覆盖范围更大的计算机网络，即网络的网络。
    * 发展过程：单个网络->互联网，三级互联（主干网，地区网，校园网），多层次互联网服务提供者
* 万维网：略
* 互联网标准化：互联网协会ISOC负责
* 互联网组成：
    * 边缘用户（用于通信和资源共享的终端）：小至嵌入式，大到服务器集群
        * 端用户通信：服务器/客户端（C/S），对等（P2P）
    * 核心部分（提供联通和交换的路由器集群）：路由器互联实现分组交换
* 核心技术：交换技术
    * 电路交换：转接电话线，需要建立连接，使用完要释放
    * 分组交换：分开运输，带上首部（包含目的地与源地址等），目的地在去除包装再组装
    * 报文交换：不分开，直接包装运输，已经死透了
* 以作用范围分类：
    1. 广域网：数千公里
    1. 城域网：50km
    1. 局域网：1km
    1. 个人局域网：10m
    1. 多机处理系统（不算网络）：多机处理系统
* 使用者分类：公用网，专用网，接入网（将用户接入互联网）
* 性能指标：以水管举例
    * 速率：水流量
    * 带宽：管子直径
    * 吞吐量：一定时间流出流入的水的体积
    * 时延：水从一段跑到另一端所需时间 = 发送速度+传输速度+中转处理（排队+处理）速度   
    * 非性能指标：费用，质量，标准化，鲁棒性，可维护性
* 体系结构：层次式协议结构——分层实现功能，统一规则
    1. 各层相对独立，仅为向上/向下负责——水平协议，垂直服务
    * OSI模型：物理层，数据链路层，网络层，运输层，会话层，表示层，应用层
        * 又臭又长，基本没人要
    * TCP/IP模型：网络接口（1，2），网际层ip（3），运输层TDP/UDP（4），应用层http，dns等（5，6，7）
        * 协议族：
    * 五层协议：逐层打包/开箱
        1. 物理层，bit流
        1. 数据链路层，确保相邻节点的数据帧传输无误 
        1. 网络层，负责在路由层面发送接收ip数据报
        1. 运输层，为两个主机的进程提供报文服务
        1. 应用层：传输数据单元，直接为用户的应用进程提供服务

## C2 物理层
* 术语：连续信号/模拟信号，离散信号/数字信号，参考DSD
* 定义：只关心bit流传输，规定接线器物理规格，电压范围，功能特性
* 数据通信系统：源系统，传输系统，目的系统
* 信道Channel：以交互信息分类——单向（单工），双向交替交通（半双工），双向同时通信（全双工）
    * 信道的极限频率：信号受干扰使得码元间隔模糊，即码间干扰  
    香农公式：$C = W\log_{2}(1+S/N) bit/s$
    * 信噪比：信号平均功率与噪声平均功率之比 = $10\lg(S/N)$
* 对基本频带信号的调制与解调：也可称为数字信号编解码
    * 方式：调幅——振幅，调频——频率，调相——相位差
* 编码方式
    * 不归零：默认
    * 归零制：正脉冲为1，负脉冲为0
    * 曼彻斯特编码：采样周期间上越变为0，下越变为1（始终代表下一个周期数字）
    * 差分曼彻斯特编码：采样时越变为0，没有越变为1（始终代表下一个周期数字）
* 传输媒体
    1. 导引型传输媒体：双绞线，同轴电缆，光纤
    1. 非导引型传输媒体：无线传输
* 信道复用：两端架设复用器与分用器：仅需一根线即可承担多根线的任务  
    复用：承担多种用途  
    * 时分复用：时间片，根据复用器输入动态规划时间分割方式成为异步时分复用
    * 波分复用：不同频率的光
    * 码分复用：多位bit代表某一个输入端的1bit，该多位bit称为码片。要求不同码片的内积为0，用于自己的内积为1
* 数字传输系统：统一标准
    * 宽带接入：利用现有的电话线，低频传递声音的模拟信号，高频划分上行信道与下行信号——ADSL非对称数字用户线
    * 光纤同轴混合网：超高速光纤干道，同轴电缆支道
    * 光纤到户：全光纤，分路器

## C3 数据链路层
* 数据链路协议数据单元：帧  
    链路层将网络层的ip数据报包装后由物理层发送，接收方的物理层完全收到后进行校验，无误则将其交给网络层  
    以下基于ppp协议
    * 封装成帧：
        1. 帧首部：F(flag)== 0x7E，A(adress)==0xFF，C(control)==0x03，  
          协议：0x0021：ip数据报,0xC021：PPP控制LCP,0x8021：网络层控制数据
        1. 帧尾部:FCS帧检验序列，F(flag)== 0x7E
    * 透明传输：数据部分转义字符(0x7E)屏蔽假的首尾部,针对本身(0x7D,0x5D)  
    同步传输（一连串比特连续传输）时每5个一就补0，在接收端执行相反操作
    * 校验检测：CRC循环冗余校验  
        不能避免帧重复接受，帧丢失——帧编号，确认与重传机制
        1. 生成多项式：由特定规则决定多项式
        1. 附加0位：增加规定规则决定个数的0
        1. 异或除法：除数为多项式余数为校验码  
        1. 检验：相同的办法生成多项式进行计算，余数为0则校验无误
    * PPP协议
        * 需求：简单，易操作；帧封装；透明性；多重网络协议支持；多类型链路支持；差错检验；连接检验；最大传输……
        * 组成：封装ip数据报的方法；链路控制系统；网络控制协议
        * 工作状态：链路建立（通过ppp发送lcp分组），LCP配置和协商，鉴别，打开

* 局域网拓扑：星形，环形，总线
    * 共享媒体资源：静态划分信道，动态媒体接入控制（冲突控制，轮询）
    * 数据链路层子层：逻辑链路控制（LLC），媒体接入控制（MAC，传输媒体内容，对LLC透明）
    * 适配器：网卡，现已集成在主板，对于超高速需求仍有PCIe扩展（万兆网口，光纤）
    * CSMA/CD协议：载波监听多点接入/碰撞检测，Carries Sense Multiple Access with Collision Detection
        * 多点接入：该总线上有多个设备，都使用相同协议
        * 载波监听：始终检测信道，包括发送时
        * 碰撞检测：同上，检测到碰撞后会重新随机发送，被碰撞的包会抛弃
            > 中译中
            1. 满打满算一个来回内能检测到是否碰撞
            1. 争用期：停止发送数据后，缓冲随机时间后再发送，这个随机时间由在$(0,2^{k}-1)*最小时间片$ 中抽取，其中k为重传次数，超过16便上报
            1. 最短帧长度：如果帧过短，那么发生冲突时帧已经发送完毕（无法中止发送，也不能重发）
            1. 强化碰撞：检测到冲突发出认为干扰信号
            1. 
    * 集线器：物理层转发bit
    * 信道利用率：发送时间占发送平均时间的占比，剩下的被碰撞争用期占据
* MAC层：物理地址，以太网地址，网卡唯一标识符
    * 前三个字节是生产厂家的唯一标识，后三字节由厂家自由决定，生产时固化在ROM中
        1. 第一字节第一位：0/1 -> 单站地址/组地址
        1. _______第二位：0/1 -> 正版/盗版
    * 标识帧：单播帧（终点站），广播帧（发给本局域网所有站点），多播帧（部分站点）
    * 格式
        1. 物理层：7B 前同步码，1B 帧开始定界符，后跟MAC帧
        1. MAC层：6B 目的地址，6B 源地址，2B类型，46~1500IP数据报，4B FCS校验序列
    * 校验：数据长度对不上或过长，帧长度不是字节，FCS失败
    * 发送冷却：9.6us清除缓存准备下一帧
* 物理扩展：
    > 冲突域：发出帧会产生碰撞  
    > 广播域：发出的广播通信能接收
    1. 集线器：物理层连接，形成树状结构
        * 缺点：更容易冲突
    1. 网桥：MAC层连接，充当冲突域间的桥梁
        * 自学习算法：根据MAC帧记录地址映射
        * 透明网桥：站点不知道网桥的存在
        * 缺点：转发时延，没有流量控制，过多用户引起网络堵塞
    1. 交换机：链路层连接，多接口网桥，全双工工作，并行
        * 没有碰撞域
        * 硬件转发，端口缓存，自学习算法
        * 生成树协议：逻辑上切断某些链路以形成无环路的树状结构
    * 非物理扩展：虚拟局域网，不按物理位置划分广播域
        * 划分方法：交换机接口，网卡MAC，协议类型，IP子网，高层应用
        * MAC帧标准：扩展格式——源地址后加4B标记
* 高速以太网：
    1. 100BASE：全双工无冲突，最大线缆100m，帧间隔0.96us
    1. Gbit：基于现有以太网/光纤，全双工/半双工
        * 半双工下的碰撞检测，新增功能
            * 载波延伸：MAC帧不足512B时填充字符以确保最短帧64B，争用时间512B
            * 分组突发：大量短帧发送时只需要第一个帧填充

## C4 网络层
> 这是一坨巨大的屎山
* 可靠交付：虚电路——逻辑连接
    * 利用IP协议统一，无需关心细节
* 尽力交付：数据报服务，成本低，最广泛
### TCP/IP协议：
* 配套协议：
    1. 地址解析协议ARP：IP地址解析出MAC地址，每个主机都有一个ARP高速缓存存有该映射，如果没有映射则向局域网请求
    1. 网络控制报文协议ICMP：标准协议，允许主机报告差错与异常，但不是高层协议（报文塞在IP数据报的数据部分）
        * 报文协议：
            1. 8b类型，8b代码，16b校验和：
                * 差错报文：终点不可达，超时，参数问题，重定向
                * 询问报文：回送/回答报文，时间戳请求/回答报文
            1. 32b取决于类型。数据部分
        * 应用：ping
    1. 网络组管理：IGMP
    * 不同的局域网有不同的规格，通过中继系统连接（转发器，网桥，桥路器，路由器，网关）
* IP数据报：首部20B+数据
    * 固定部分：
        1. 4b版本：ipv4/ipv6
        1. 4b首部长度
        1. 8b区分服务：不使用
        1. 16b总长度：首部+数据
        1. 16b标识
        1. 3b标志（1还有分片/0最后分片）,13b片偏移
            * 超大数据会被分割为多个IP数据报，称为片
        1. 8b生存时间（最大路由通过数）
        1. 8b协议：该数据应交给哪个进程：TCP，UDP，ICMP,IGMP,OSPF
        1. 16b首部检验和：不采用CRC
        1. 32b源地址
        1. 32b目的地址
    * 可变部分：可选字段，填充
    * 编码方式：
        1. 分类IP：按照网络号分类
            * A，B，C：1B，2B，3B作网络分组标记
            * D类：多播地址，更好的一对多通信，降低带宽占用，需要硬件支持
                * 协议字段为2，使用IGMP（目前更新到第三代IGMP），没有ICMP差错报文
                * 地址范围：在mac层上动手脚，需要重新处理映射关系：  
                标记为D类的IP地址，前5位为D类标记，后23位对应以太网（mac层）的后23位
                * 使用网际组管理协议IGMP管理多播组成员，它不知道下游成员的信息，只知道在本地局域网下是否有主机参与和退出。
                * 复杂：多播成员可能不再同一个路由下，发送者可以不是成员，
                * 报文：加入多播组，周期性探询（只要一个主机响应即可）
                * 多播路由考虑的可就多了：
                    * 从哪来到哪去
                    * 洪范与剪枝：RPB算法，不是从最短路径传来的多播数据报丢弃
                    * 隧道技术：多播数据报塞进单播IP数据报中，适用于物理距离较远的情况
                    * 基于核心的发现技术：每一个多播组指定一个核心路由由他接受IP单播地址
            * E类：保留
                * 主机号为0一般指路由主机
                * 网络号为0指主机host-id
                * 全1：本网络广播，路由器不转发
                * netid+全1：在子网下广播
                * 127：本地软件环回测试
        1. 子网划分：在ip地址中将部分主机号字段划为子网字段，成为3级IP地址
            * 没有硬件划分
            * 子网掩码：找出IP地址中的子网部分—— IP地址与子网掩码进行与运算后在判断是否属于同一网段
                * 划分子网掩码，比如装监控：三个网段，256*3（另外的1个丢弃），前22位不变（即掩码），即192.168.0.1/22  
                    eg. /25：25位子网掩码，可接入$2^{32-25}-2$的主机：第0个作为网络地址，第-1个作为广播地址
                * 路由器交换信息时必须交换子网掩码，由于IP报文不包括网络掩码所以需要解码地址后再决定是否交付
                * 变长子网掩码：提高ip资源利用率
            * 无分类编制CIDR： 使用网络前缀代替分类地址的网络号和子网号（变相的子网掩码/24）
                * 其他表示方法：10/10（前10位为1，10位掩码）00010*010（*前前缀，*后主机号）
                * 最长前缀匹配：优先匹配子网站点最少的（/后数字最大的）
                * 二叉树树查找优化路由表查询：按位查，左0右1
        1. 超网：又称路由聚合，通过修改子网掩码将C类地址聚合在同一网段下而来以减少网关的开销

### 路由器（等价于网关）
* 理想路由：算法正确完整简单稳定公平，自适应（静态/动态）
    * 最佳路由：当前情况下的最佳选择
    * 分层设计：大规模，隐私性
* 自洽系统：对内可以乱搞并保证隐私，但对外可作为一个整体同等处理
* 路由选择协议：
    * 内部网关协议
        * 路由信息协议RIP：网络中每一个路由都维护着自己到其他每个目的网络的距离记录。  
            仅与相邻路由固定间隔交换自己的路由表。但收敛速度快。  
            以下是算法
                > 这里的距离指的是经过的路由器数量，最多15跳，只会记录一条最短  
            1. 收到RIP报文后，该报文所有目标地址的端口全部指向报文发出者，距离+1
                * 距离向量算法：从任意节点拆分为两个路径，节点到两个路径均最短
            1. 添加目的网络（如果不存在），更新地址（不同端口相同目的），更新端口（相同目的且跳数更小）
            1. 三分钟没有收到更新路由表则标注位不可达路由
            * RIP2协议报文：塞在UDP用户数据报中，4B首部，20B路由信息，至多25个，超出再发一个报文。
                * 特点：好消息传得快，坏消息传得慢——网络故障需要数分钟才能传遍所有路由，每次扩散需要循环发送直至最大跳数
                * 两个网络间只能使用一条线路
                * 实现简答开销小，但限制规模——15最大跳数和完整路由表
        * 开发最短路径优先OSPF：使用Dijkstra的最短路径算法
            * 向本区域中所有路由器发送信息——与本路由器相邻的所有路由器的链路状态，30分钟一次
            * 每个路由器建立一个链路状态数据库，即全网的拓扑结构
            * 使用区域划分适应更大规模的网络，区域间只有个一路由相连
            * 使用IP数据报，数据短，不会分片传输导致丢包重发
            * 可平衡路径负载
            * 分组类型：问候（确定可达性），数据库描述（同步数据库），链路状态请求，链路状态更新，链路状态确认（更新数据库）
    1. 外部网关协议EGP，BGP-4（最常用）
        * BGP协议：发言人机制——自洽系统间的干道
            * 交换可达性：到达目标网络所经过的一系列AS
            * 数量级更小，可使用CIDR，塞在TCP中
            * 报文：打开，更新，保活（检查连接），通知（检测到差错）
* 物理结构：具有多个接口的专用计算机，专注于转发分组，工作在网路层
    * 路由控制：依据协议构造维护路由表，上文已经阐明
    * 分组转发：接受输入并处理，缓冲区排队，处理输出并发送
        * 分组丢弃：缓存溢出
        * 交换结构：处理器（有形的大手） 总线（共享总线直接传输）互联（水平输入，垂直输出）
            
### IPv6
* 背景：深厚历史的IPv4的32位地址已经耗尽，使用128位的IPv6
* 改进：更大的地址空间与层次方式，可扩展首部，允许协议扩展，即插即用  
* 结构：  
    1. 4b版本 
    1. 8b通信量类（区分类别与优先级）  
    1. 20b流标位（相同的始终点具有相同的标号）
    1. 16b有效载荷长度（除首部以外的数据，最高64kB）
    1. 8b下一首部（v4的协议字段，扩展首部）
        * 分类：逐跳选项,路由选择,分片,鉴别,封装安全有效载荷,目的站选项
    1. 8b跳数限制（字面意义）  
    1. 128b源地址，目的地址
        * 目的地址：单播，多播，任播（交给目的站一堆计算机中最近的一个）
* 地址表示：16进制，隔4插冒号，全0只用一个0
    * 省略表示-> ::/n  
    双冒号代表被省略的数字，/n表示被省去的位数
    * 环回地址::1/128,多播地址11111111
    * 单播地址：0/1/2分类地址
* 向下兼容：
    * 双协议栈：同时处理ipv4和ipv6
    * 隧道技术：将v6数据报封装成v4数据报
* ICMPv6
    * ARP和IGMP合并到ICMPv6中
    * 新增报文类别：邻站发现报文ND，组成员关系报文MLD

### 虚拟专用网络VPN 
> **每一堵墙最后都会称为旅游景点**
* 问题：IP地址紧缺，易出现本地地址和全球地址的二义性问题；网络安全
* 解决：指明私有地址，不能作为全球地址，数据报将私有地址作为目的地址时不转发
    1. 10.0.0.0 到 10.255.255.255  
    A类，或记为10.0.0.0/8，它又称为 24 位块
    1. 172.16.0.0 到 172.31.255.255  
    B类，或记为172.16.0.0/12，它又称为 20 位块
    1. 192.168.0.0 到 192.168.255.255  
    C类，或记为192.168.0.0/16，它又称为 16 位块
    * 使用私有IP地址称为私有互联网
* VPN：利用公用互联网作为各私有互联网间的通信载体
    * 使用隧道技术，打包数据报，可以加密保证安全
        > 即使加密也可以识别出异常流量，作为防火墙的一部分技术
    * 内联网，外联网：两部门之间，第三方参与
    * 远程接入VPN：公司外的员工访问公司网络
    * 网络转换地址NAT：翻译器，将私有地址与全球地址间转换，使用运输层的端口号提升全球ip的利用率  
    至少一个有效外部全球IP地址，需要路由器安装软件

### 多协议标记交换MPLS
可以在其上层采用多种协议，通过标记分组进行转发
* 基本原理：IP数据报上标记，据此硬件转发（标记分配协议LSR），不用查找转发表
* MPLS协议域：一群支持MPLS的路由器
    * 进入打上标记，域内可以通过LSR协议和专用转发表快速转发，出去再去除标记
    * 标记在MAC帧和IP数据报间：20b标记值，3b保留，1b栈，8b生存时间
* 转发等价类FEC：对于部分输入接口和输出接口视作等价
    * 划分灵活，用于流量控制