# 计算机网络速通
## 前言
* 坏消息：还是计网的那个老师
* 好消息：熟练多了
* 坏消息：这是她第二次讲这门课
* 好消息：教材也是一坨，现实的网络架构也是一坨
* 不用背首部格式：考研题会给
    > 如果她没给，**我[优美的中国话]**
> 2025.3.8 开始基于原课程上补充以适应408

## C0：概括
从下到上：物理，链路，网络，运输，应用
1. 应用层：**插槽socket**，应用层协议——DNS，http，SMTP（电子邮件）  
    * 
1. 运输层：**TCP/UDP协议**：首部+[上层数据]
    * 拥塞控制（端到端），流量控制（全局）
1. 网络层：**ip数据报**：首部+[上层数据]
1. 链路层：**以太网mac帧**：mac目的地址，mac源地址，[上层数据]，帧结束
1. 物理层：7B同步码（1010101...）+ 1B帧开始（10101011）

* 首部内容：必带源地址和目标地址，不同的首部不同的协议，如版本，协议，数据长度和校验，标记等
* 往下看是封装好的函数，只负责调用；往上看是实现功能

## C1：概述
### 1.1 分类
* 互联网组成：
    * 组成部分方向：硬件，软件，协议
    * 工作方式方向：边缘部分与核心部分
    * 功能方向：通信子网（传递数据，控制）与资源子网（共享计算资源/存储的数据）

* 功能：
    * 数据通信
    * 资源共享：软件，数据，硬件
    * 分布式处理
    * 高可靠
    * 负载均衡

* 核心技术：交换技术
    * 电路交换：通过转接电话线实现直连
        * 一对一直连---时延小，有序传输，无冲突，简单控制
        * 物理信道---建立连接慢，线路利用率低，不灵活，没有差错控制
    * 报文交换：直接包装发送的数据，通过相邻节点的转发来抵达目的
        * 临节点---不用建立连接，动态规划，多线路利用
        * 多节点---转发时延，缓存开销
        * 不处理数据---差错问题
    * 分组交换：在报文基础上将大数据分装成小份再发送
        * 优点同上
        * 小数据包---更高效的线路利用，缓解节点压力，差错影响
        * 更多的包装---传递额外信息，时序

* 拓扑结构分类：总线，环形，网状，星型

* 使用者分类：公用网，专用网，接入网（将用户接入互联网）

* 以作用范围分类：
    1. 广域网：数千公里
    1. 城域网：50km
    1. 局域网：1km
    1. 个人局域网：10m
    1. 多机处理系统（不算网络）：多机处理系统

* 传输介质：有线（双绞线，同轴电缆，光纤）无线（蓝牙，微波，无线电）

* 性能指标：以水管举例
    * 速率：水流量
    * 带宽：管子直径---最大速度/信号频率
    * 吞吐量：一定时间流出流入的水的体积
    * 时延：水从一段跑到另一端所需时间 = 发送速度+传输速度+中转处理（排队+处理）速度
        * 时延带宽积：当数据到达终点时总共已发送的数据   
        * **往返时延Round-Trip Time-RTT** ：从发送端发送分组到接收来自接收端的确认的时间
    * 非性能指标：费用，质量，标准化，鲁棒性，可维护性

### 1.2 **体系结构**：
* 基本原则：
    1. 每层实现一种相对独立的功能
    1. 层间接口清晰，相互交流少
    1. 下层独立于上层，上层单向利用下层服务
    1. 只关心要求，不关心实现
* **协议**：事先约定好数据格式等相关问题---语法，语义，时序
    * 每一层都使用相同的数据单元，即PDU，包含服务数据单元SDU（数据）和协议控制信息PCI（数据头）
* **接口**：同一层次实体间的交流的出入口
* **服务**：功能调用
    * 四类原语：请求-指示，响应-证实 ？？
    * 分类方式：面向连接/无连接，可靠/不可靠，有应答/无应答
* 各层相对独立，仅为向上/向下负责——水平协议，垂直服务
* TCP/IP模型：网络接口（1，2），网际层ip（3），运输层TDP/UDP（4），应用层http，dns等（5，6，7）
* OSI模型：服务-协议-接口
    1. 物理层：bit，定义终端与通信的物理与逻辑连接
    1. 数据链路层：帧，管理物理介质传输---帧封装解封，mac寻址，错误检测纠正，冲突检测
    1. 网络层/网际层：数据报，确保端到端传输---路由选择，ip寻址，分组转发，拥塞控制，差错控制
    1. 运输层：段（TCP），数据报（UDP），保证点对点传输---可靠传输，多路复用，错误检测，连接管理，安全管理
    1. 应用层：
        1. 会话层：逻辑链路管理
        1. 表示层：数据结构转换，加解密
        1. 应用层：用户与网络的接口
    * 差别：现有osi再有TCP/IP，前者更通用，后者更广泛
> 符号问题
> 速率表示时：k-M-G-T,1000为单位
> 存储表示时：k-M-G-T,2^10= 1024为单位

### C1.0 弃用
* 较准确的定义：计算机网络主要是由一些通用的、可编程的硬件，互连而成的。硬件功能不单一，传递数据类型多样，支持广泛的日益增长的应用
* 互联网：
    * Internet：特指，由数量极大的各种计算机网络互连起来而形成的一个互连网络。它采用 TCP/IP 协议族作为通信规则，是一个覆盖全球、实现全球范围内连通性和资源共享的计算机网络
    * Internet：由多个计算机网络（简称网络）通过一些路由器相互连接起来，构成了一个覆盖范围更大的计算机网络，即网络的网络。
    * 发展过程：单个网络->互联网，三级互联（主干网，地区网，校园网），多层次互联网服务提供者
* 万维网：略
* 互联网标准化：互联网协会ISOC负责



## C2 物理层
### 2.1 定义
* 只关心bit流传输，规定接线器物理规格，电压范围，功能特性
* 术语：连续信号/模拟信号，离散信号/数字信号，参考DSD
* 数据通信系统：源系统，传输系统，目的系统
* 速率：波特率/比特率，一个按码元算，一个按二进制算
* 信道Channel：以交互信息分类——单向（单工），双向交替交通（半双工），双向同时通信（全双工）
    * 信道的极限频率：信号受干扰使得码元间隔模糊，即码间干扰  
    * 香农公式：$C = W\log_{2}(1+S/N) bit/s$
    * 奈奎斯特公式：$C = 2Wlog_2 N$
    * 信噪比：信号平均功率与噪声平均功率之比 = $10\lg(S/N)$
* 对基本频带信号的调制与解调：也可称为数字信号编解码
    * 方式：调幅——振幅，调频——频率，调相——相位差
* 编码方式
    * 不归零：默认
    * 归零制：正脉冲为1，负脉冲为0
    * 曼彻斯特编码：采样周期间上越变为0，下越变为1（始终代表下一个周期数字）    
    **0上1下，间隔** 
    * 差分曼彻斯特编码：采样时越变为0，没有越变为1（始终代表下一个周期数字）  
    **0变1不变，采样**
### 2.2 传输媒体
1. 导引型传输媒体：双绞线，同轴电缆，光纤
1. 非导引型传输媒体：无线传输
### 2.3 物理层设备
* 中继器：整形，放大，转发信号
* 集线器：多端口中继器



## C3 数据链路层
### 3.1 功能
* 主要任务：在一段链路上传递帧
    * 链路管理：建立连接，维持和释放
    * 透明封装：一段数据前后会添加首部和尾部，数据中与标志位相同时不会影响传输
        > |标志|地址|控制|信息|检验|标志|
        > |-|-|-|-|-|-|
        > |01111110| 8bit | 8bit | N位可变 |16bit | 01111110 |
    * 流量控制：限制发送方速度，使得接收方能及时处理避免溢出    
    OSI体系中规定链路层也会有流量控制，在TCP/IP体系中转移至传输层（TCP/UDP）
    * 差错检测：帧中的bit可能翻转，帧丢失，帧重复  
    **不使用确认重传，仅丢弃差错帧**
* 基本概念：
    * 链路：一个节点到相邻节点的物理线路
    * 数据链路：在链路的基础上增添通讯协议
    * 帧：协议数据单元
* 服务提供：有/无确认的无连接服务，有确认的有连接服务
    * 确认：目标主机收到帧后需要返回确认
    * 连接：发送帧之前是否需要建立链路连接。

### 3.2 组帧（封装成帧）
* 帧定界：
    * 字符计数法：首部有一段记录帧长度（字节为单位，包括本体）
    * 字节填充法：使用特定字节标记头与尾，数据字段中如果包含该特定字节，需要添加转义符号避免误触
    * 零比特填充法：使用01111110标记头尾，数据字段中每五个1，后面插入一个0避免误触
    * 违规编码：在曼彻斯特编码中，高-高与低-低电平对违规，但可作为定界符

### 3.3 差错控制
* 差错控制分两种：自动重传ARQ，前向纠正FEC
* 检错校验：
    * 奇偶校验：只需一位检验位，标记1的个数。只能检查是否出错，可能无法检验出
    * 循环冗余校验：双方约定一个定值，校验码是数据段除以定值，检验时数据连校验码一起除以定值，没有余数即无差错
    > 除法进行位逻辑异或
* 纠错编码：海明码
    1. 检验码插入在$2^n$上：1，2，4，，8，16…
    1. 插入后形成新的位数，每个非检验位的位数决定了由哪些检验位检验
        * 比如第7位的数据由1，2，4位的海明码检验：7 = 1+2+4
    1. 检验位范围内的数据做异或
    1. 检验原理：每个检验位与范围内做奇偶校验，校验后的数据为出错位数

### 3.4 流量控制
* 数据链路层：控制相邻节点的流量，接收方溢出不返回确认
* 传输层：控制端到端流量，接收方的确认报文可以调整发送方窗口
* 停止-等待控制方法：发送一帧后只有接收到确认才发下一帧
* 滑动窗口控制：发送方和接受方均维持一组特定序列
    * 发送方：序列中可以无需等待直接发送，已经发送不会二次发送，收到已发送帧的确认窗口往后移动
    * 接收方：只接受窗口内的帧，确认接收后窗口往后移动
* 可靠传输机制：
    * 基本机制
        1. 帧编号：标记帧的序列号
        1. 确认机制：接收方发送ACK通知发送方成功接收该帧  
        为了降低开销，允许接收方合并确认确认编号，此时ACKn代表确认n及之前的帧确认接收
        1. 定时器：发送方发送一帧后会启动计时器
        1. 错误处理：
    * 停止-等待Stop-and-wait：即停止-等待控制方法，发送接收窗口大小为1
    * 后退go-back-N：允许发送窗口大于1，发送的N个帧中有一个帧确认超时，则窗口回退到超时帧进行重传
    * 选择重传selective-repeat：允许发送接收窗口大于1，只有接收窗口全部确认才移交上层并窗口后移  
    此时接收方的校验错误可以发出否定帧NAKn，发送方接收到后立即重传
* 信道利用率分析：发送时间占据动作周期的时间

### 3.5 介质访问
* 信道复用：两端架设复用器与分用器：仅需一根线即可承担多根线的任务  
    > 复用：承担多种用途  
    * 频分复用FDM：划分总频带
    * 时分复用TDM：划分时间片，根据复用器输入动态规划时间分割方式成为异步时分复用
    * 波分复用WDM：不同频率的光
    * 码分复用CDM：使用-1和1表示代替0和1，多位bit代表某一个输入端的1bit，该多位bit称为码片。要求不同码片的内积为0，用于自己的内积为1
        * 内积：相同位置的数字相乘，积相加
        * 数据集中：直接相加，没有上限
        * 数据分离：叠加信号与码片序列内积---$\frac{1}{N}\sum_{i=1}^{n}R_i\cdot C_i$
* 随机访问介质访问控制协议---信号冲突与争用
    * ALOHA
        * 纯ALOHA：不检测就发送，知道发送成功
        * 时隙ALOHA：规定时隙，站点只能在时隙开始时才能发送
    * CSMA：载波监听多路访问Carrier Sense Multile Access
        * 1-坚持CSMA：直到信道空闲才发送
        * 非坚持CSMA：站点发送数据时监听信道，若信道繁忙，随机时间后监听
        * p-坚持CSMA：仅适用时分信号---站点发送数据时监听信道，若信道空闲，以p概率发送，1-p概率推迟到下一个时隙
        * CSMA/CD：至多1RTT发送方知道自己发送的信号受到干扰（信号叠加超出阈值）
            * 如果发送帧过短，则无法确认，保证最短帧长=RTT*信道带宽
            * RTT内没有检测到干扰，则认定这次发送没有干扰
            * RTT内检测到干扰，则$random(0,2^n -1)*RTT$时间后重传
            * 强化碰撞：检测到冲突发出认为干扰信号
            > 10Mb/s，最小时间片51.2us，百兆更小
        * CSMA/CA：冲突检测在非导引型介质中效果不佳，故改为冲突避免
            * 使用ARQ为SW
            * 如果信道空闲，在一个时隙后发送，否则随机时间等待后再发送
            * 针对不了解信道上的设备，发送方会发送一个RTS帧（Request to Send）请求对方预留信号，接收方回复CTS（clear to send）确认信号预留，其他设备收到不是自己的RTS和CTS会推迟自己的发送  
* 轮询访问：令牌传递协议
    * 在环形拓扑/总线拓扑中通过中控主机控制网络传输
    * 主机发送空令牌，需要发送的数据只能在获得令牌后填入令牌，再发送
    * 总线上设备检查令牌是否是自己的，否则转发
    * 发送方接收到自己填写的令牌，检查是否有差错，否则重传
    * 适合高负载信道，尽量避免冲出
    * 优先级机制

### 3.6 局域网
* 定义：较小范围内由引导介质组成资源和信息共享的计算机互联网络
    * 有限的地理范围和节点数量，高速率低延迟
    * 拓扑方式：以太网，令牌环，FDDI
    * 有限层：物理层与数据链路层，链路层又分为逻辑链路和介质访问链路
* MAC：高3位字节为厂商，低三位字节由厂商决定，生产时固化在ROM中
* 以太网：目前最流行的有线局域网技术
    * 简化通信：无连接，不可靠服务，曼彻斯特编码，码元通过电压转换区分
    * 传输介质：粗/细同轴电缆，非屏蔽双绞线，光线对
    * 计算机通过网络适配器实现连接，适配器每收到一个帧时先检查是不是给自己的
        * 单播帧（终点站），广播帧（发给本局域网所有站点），多播帧（部分站点）
    * 以太网MAC帧：介绍Ethernet V2标准
        1. 物理层：
            1. 7Btye 前同步码
            1. 1Btye 帧开始定界符
            1. MAC帧：
                1. 6Btye目的地址（物理地址）
                1. 6Btye源地址（物理地址）
                1. 2Btye类型：交给哪个上层协议处理
                1. 46~1500IP数据报
                1. 4Btye FCS校验序列，不包括同步码与定界符
        * 不需要结束定界符：帧之间存在间隙，使用违规编码区分码元
* 无线局域网：
    * 固定基础设施：预先建立的基站，使用802.11标准
        * 星型拓扑，中心接入点称为AP，需要标识符SSID
        * 最小构建：基本服务集BSS：Basic Service Set，任何通信必须经过AP
        * 多个BSS可做成ESS
    * 无固定基础设施移动自组织网络
        * 节点间平等，都具有路由功能
        * 发现新设备，自动组网
    * 局域网MAC帧：**复杂首部**
        1. 2Byte帧控制：协议版本，类型，子类型，**去往AP**，**来自AP**，更多分片，重试，功率管理，更多数据，WEP，顺序
        1. 2Byte持续期
        1. 6Byte地址1
        1. 6Byte地址2
        1. 6Byte地址3
        1. 2Byte序号控制
        1. 6Byte地址4：站不考虑
        1. 0-2312Byte帧主体
        1. 4Byte FCS
        * 前三个地址的含义：
            * 来自AP：目的地址-自己AP地址-源地址
            * 去往AP：AP地址-源地址-目的地址
### 3.7 广域网




### 数据链路协议数据单元：帧  
链路层将网络层的ip数据报包装后由物理层发送，接收方的物理层完全收到后进行校验，无误则将其交给网络层  
以下基于ppp协议
* 封装成帧：
    1. 帧首部：F(flag)== 0x7E，A(adress)==0xFF，C(control)==0x03，  
        协议：0x0021：ip数据报,0xC021：PPP控制LCP,0x8021：网络层控制数据
    1. 帧尾部:FCS帧检验序列，F(flag)== 0x7E
* 透明传输：数据部分转义字符(0x7E)屏蔽假的首尾部,针对本身(0x7D,0x5D)  
同步传输（一连串比特连续传输）时每5个一就补0，在接收端执行相反操作
* 校验检测：CRC循环冗余校验  
    不能避免帧重复接受，帧丢失——帧编号，确认与重传机制
    1. 生成多项式：由特定规则决定多项式
    1. 附加0位：增加规定规则决定个数的0
    1. 异或除法：除数为多项式余数为校验码  
    1. 检验：相同的办法生成多项式进行计算，余数为0则校验无误
* PPP协议
    * 需求：简单，易操作；帧封装；透明性；多重网络协议支持；多类型链路支持；差错检验；连接检验；最大传输……
    * 组成：封装ip数据报的方法；链路控制系统；网络控制协议
    * 工作状态：链路建立（通过ppp发送lcp分组），LCP配置和协商，鉴别，打开

### 局域网拓扑：星形，环形，总线
* 共享媒体资源：静态划分信道，动态媒体接入控制（冲突控制，轮询）
* 数据链路层子层：逻辑链路控制（LLC），媒体接入控制（MAC，传输媒体内容，对LLC透明）
* 适配器：网卡，现已集成在主板，对于超高速需求仍有PCIe扩展（万兆网口，光纤）
* 集线器：物理层转发bit
* 信道利用率：发送时间占发送平均时间的占比，剩下的被碰撞争用期占据
### MAC层：

* 格式

* 校验：数据长度对不上或过长，帧长度不是字节，FCS失败
* 发送冷却：9.6us清除缓存准备下一帧
### 扩展：
> 冲突域：发出帧会产生碰撞  
> 广播域：发出的广播通信能接收
1. 集线器：物理层连接，形成树状结构
    * 缺点：更容易冲突
1. 网桥：MAC层连接，充当冲突域间的桥梁
    * 自学习算法：根据MAC帧记录地址映射
    * 透明网桥：站点不知道网桥的存在
    * 缺点：转发时延，没有流量控制，过多用户引起网络堵塞
1. 交换机：链路层连接，多接口网桥，全双工工作，并行
    * 没有碰撞域
    * 硬件转发，端口缓存，自学习算法
    * 生成树协议：逻辑上切断某些链路以形成无环路的树状结构
* 非物理扩展：虚拟局域网，不按物理位置划分广播域
    * 划分方法：交换机接口，网卡MAC，协议类型，IP子网，高层应用
    * MAC帧标准：扩展格式——源地址后加4B标记
* 高速以太网：
    1. 100BASE：全双工无冲突，最大线缆100m，帧间隔0.96us
    1. Gbit：基于现有以太网/光纤，全双工/半双工
        * 半双工下的碰撞检测，新增功能
            * 载波延伸：MAC帧不足512B时填充字符以确保最短帧64B，争用时间512B
            * 分组突发：大量短帧发送时只需要第一个帧填充

## C4 网络层
> 这是一坨巨大的屎山
* 可靠交付：虚电路——逻辑连接
    * 利用IP协议统一，无需关心细节
* 尽力交付：数据报服务，成本低，最广泛
### TCP/IP协议：
#### 配套协议
1. 地址解析协议ARP：IP地址解析出MAC地址，每个主机都有一个ARP高速缓存存有该映射，如果没有映射则向局域网广播
    * 请求报文中的mac地址为全f——广播
1. 网络控制报文协议ICMP：标准协议，允许主机报告差错与异常，但不是高层协议（报文塞在IP数据报的数据部分）
    * 报文协议：
        1. 8b类型，8b代码，16b校验和：
            * 差错报文：终点不可达，超时，参数问题，重定向
            * 询问报文：回送/回答报文，时间戳请求/回答报文
        1. 32b取决于类型。数据部分
    * 应用：ping
1. 网络组管理：IGMP
* 不同的局域网有不同的规格，通过中继系统连接（转发器，网桥，桥路器，路由器，网关）
#### IP数据报
首部20B+数据
* 固定部分：
    1. 4b版本：ipv4/ipv6
    1. 4b首部长度
    1. 8b区分服务：不使用
    1. 16b总长度：首部+数据
    1. 16b标识
    1. 3b标志（1还有分片/0最后分片）,13b片偏移
        * 超大数据会被分割为多个IP数据报，称为片
    1. 8b生存时间（最大路由通过数）
    1. 8b协议：该数据应交给哪个进程：TCP，UDP，ICMP，IGMP，OSPF
    1. 16b首部检验和：不采用CRC
    1. 32b源地址
    1. 32b目的地址
* 可变部分：可选字段，填充
#### IP划分
* A，B，C：1B，2B，3B作网络分组标记
* D类：多播地址，更好的一对多通信，降低带宽占用，需要硬件支持
    * 协议字段为2，使用IGMP（目前更新到第三代IGMP），没有ICMP差错报文
    * 地址范围：在mac层上动手脚，需要重新处理映射关系：  
    标记为D类的IP地址，前5位为D类标记，后23位对应以太网（mac层）的后23位
    * 使用网际组管理协议IGMP管理多播组成员，它不知道下游成员的信息，只知道在本地局域网下是否有主机参与和退出。
    * 复杂：多播成员可能不再同一个路由下，发送者可以不是成员，
    * 报文：加入多播组，周期性探询（只要一个主机响应即可）
    * 多播路由考虑的可就多了：
        * 从哪来到哪去
        * 洪范与剪枝：RPB算法，不是从最短路径传来的多播数据报丢弃
        * 隧道技术：多播数据报塞进单播IP数据报中，适用于物理距离较远的情况
        * 基于核心的发现技术：每一个多播组指定一个核心路由由他接受IP单播地址
* E类：保留
    * 主机号为0一般指路由主机
    * 网络号为0指主机host-id
    * 全1：本网络广播，路由器不转发
    * netid+全1：在子网下广播
    * 127：本地软件环回测试
1. 子网划分：在ip地址中将部分主机号字段划为子网字段，成为3级IP地址
    * 没有硬件划分
    * 子网掩码：找出IP地址中的子网部分—— IP地址与子网掩码进行与运算后在判断是否属于同一网段
        * 划分子网掩码，比如装监控：三个网段，256*3（另外的1个丢弃），前22位不变（即掩码），即192.168.0.1/22  
            eg. /25：25位子网掩码，可接入$2^{32-25}-2$的主机：第0个作为网络地址，第-1个作为广播地址
        * 路由器交换信息时必须交换子网掩码，由于IP报文不包括网络掩码所以需要解码地址后再决定是否交付
        * 变长子网掩码：提高ip资源利用率
    * 无分类编制CIDR： 使用网络前缀代替分类地址的网络号和子网号（变相的子网掩码/24）
        * 其他表示方法：10/10（前10位为1，10位掩码）00010*010（*前前缀，*后主机号）
        * 最长前缀匹配：优先匹配子网站点最少的（/后数字最大的）
        * 二叉树树查找优化路由表查询：按位查，左0右1
1. 超网：又称路由聚合，通过修改子网掩码将C类地址聚合在同一网段下而来以减少网关的开销

### 路由器（等价于网关）
* 理想路由：算法正确完整简单稳定公平，自适应（静态/动态）
    * 最佳路由：当前情况下的最佳选择
    * 分层设计：大规模，隐私性
* 自洽系统：对内可以乱搞并保证隐私，但对外可作为一个整体同等处理
* 路由选择协议：
#### 内部网关协议
* **路由信息协议RIP**：网络中每一个路由都维护着自己到其他每个目的网络的距离记录。  
    仅与相邻路由固定间隔交换自己的路由表。但收敛速度快。  
    以下是算法
        > 这里的距离指的是经过的路由器数量，最多15跳，只会记录一条最短  
    1. 收到RIP报文后，该报文所有目标地址的端口全部指向报文发出者，距离+1
        * 距离向量算法：从任意节点拆分为两个路径，节点到两个路径均最短
    1. 添加目的网络（如果不存在），更新地址（不同端口相同目的），更新端口（相同目的且跳数更小）
    1. 三分钟没有收到更新路由表则标注位不可达路由
    * RIP2协议报文：塞在UDP用户数据报中，4B首部，20B路由信息，至多25个，超出再发一个报文。
        * 特点：好消息传得快，坏消息传得慢——网络故障需要数分钟才能传遍所有路由，每次扩散需要循环发送直至最大跳数
        * 两个网络间只能使用一条线路
        * 实现简答开销小，但限制规模——15最大跳数和完整路由表
* **开发最短路径优先OSPF**：使用Dijkstra的最短路径算法
    * 向本区域中所有路由器发送信息——与本路由器相邻的所有路由器的链路状态，30分钟一次
    * 每个路由器建立一个链路状态数据库，即全网的拓扑结构
    * 使用区域划分适应更大规模的网络，区域间只有个一路由相连
    * 使用IP数据报，数据短，不会分片传输导致丢包重发
    * 可平衡路径负载
    * 分组类型：问候（确定可达性），数据库描述（同步数据库），链路状态请求，链路状态更新，链路状态确认（更新数据库）
#### 外部网关协议
EGP，BGP-4（最常用）
* **BGP协议**：发言人机制——自洽系统间的干道
    * 交换可达性：到达目标网络所经过的一系列AS
    * 数量级更小，可使用CIDR，塞在TCP中
    * 报文：打开，更新，保活（检查连接），通知（检测到差错）
* 物理结构：具有多个接口的专用计算机，专注于转发分组，工作在网路层
    * 路由控制：依据协议构造维护路由表，上文已经阐明
    * 分组转发：接受输入并处理，缓冲区排队，处理输出并发送
        * 分组丢弃：缓存溢出
        * 交换结构：处理器（有形的大手） 总线（共享总线直接传输）互联（水平输入，垂直输出）
            
### IPv6
* 背景：深厚历史的IPv4的32位地址已经耗尽，使用128位的IPv6
* 改进：更大的地址空间与层次方式，可扩展首部，允许协议扩展，即插即用  
* 结构：  
    1. 4b版本 
    1. 8b通信量类（区分类别与优先级）  
    1. 20b流标位（相同的始终点具有相同的标号）
    1. 16b有效载荷长度（除首部以外的数据，最高64kB）
    1. 8b下一首部（v4的协议字段，扩展首部）
        * 分类：逐跳选项,路由选择,分片,鉴别,封装安全有效载荷,目的站选项
    1. 8b跳数限制（字面意义）  
    1. 128b源地址，目的地址
        * 目的地址：单播，多播，任播（交给目的站一堆计算机中最近的一个）
* 地址表示：16进制，隔4插冒号，全0只用一个0
    * 省略表示-> ::/n  
    双冒号代表被省略的数字，/n表示被省去的位数
    * 环回地址::1/128,多播地址11111111
    * 单播地址：0/1/2分类地址
* 向下兼容：
    * 双协议栈：同时处理ipv4和ipv6
    * 隧道技术：将v6数据报封装成v4数据报
* ICMPv6
    * ARP和IGMP合并到ICMPv6中
    * 新增报文类别：邻站发现报文ND，组成员关系报文MLD

### 虚拟专用网络VPN 
> **每一堵墙最后都会称为旅游景点**
* 问题：IP地址紧缺，易出现本地地址和全球地址的二义性问题；网络安全
* 解决：指明私有地址，不能作为全球地址，数据报将私有地址作为目的地址时不转发
    1. 10.0.0.0 到 10.255.255.255  
    A类，或记为10.0.0.0/8，它又称为 24 位块
    1. 172.16.0.0 到 172.31.255.255  
    B类，或记为172.16.0.0/12，它又称为 20 位块
    1. 192.168.0.0 到 192.168.255.255  
    C类，或记为192.168.0.0/16，它又称为 16 位块
    * 使用私有IP地址称为私有互联网
* VPN：利用公用互联网作为各私有互联网间的通信载体
    * 使用隧道技术，打包数据报，可以加密保证安全
        > 即使加密也可以识别出异常流量，作为防火墙的一部分技术
    * 内联网，外联网：两部门之间，第三方参与
    * 远程接入VPN：公司外的员工访问公司网络
    * 网络转换地址NAT：翻译器，将私有地址与全球地址间转换，使用运输层的端口号提升全球ip的利用率  
    至少一个有效外部全球IP地址，需要路由器安装软件

### 多协议标记交换MPLS
可以在其上层采用多种协议，通过标记分组进行转发
* 基本原理：IP数据报上标记，据此硬件转发（标记分配协议LSR），不用查找转发表
* MPLS协议域：一群支持MPLS的路由器
    * 进入打上标记，域内可以通过LSR协议和专用转发表快速转发，出去再去除标记
    * 标记在MAC帧和IP数据报间：20b标记值，3b保留，1b栈，8b生存时间
* 转发等价类FEC：对于部分输入接口和输出接口视作等价
    * 划分灵活，用于流量控制

## C5:运输层
* 它属于面向通信部分的最高层，同时也是用户功能中的最低层。只有位于网络边缘部分的主机的协议栈才有运输层
* 作用：进程的网络端口,称作协议端口号/端口  
    * 不同操作系统间的pid工作方式不同，运输协议和进程间的强耦合不适用
    * 16b端口号，仅限本地
        * 常用端口：ftp：21，TELNET：23，SMTP：25，DNS：53，HTTP：80，https：443，RDP：3389
        * 服务器登记端口：1024-49151，客户端短暂端口：49152-65535
        * IP协议：SNMP(trap)
    > 不同于网络层面向主机通信，运输层面向进程通信  
    > 注意：IP报承载UDP报和TCP报，但是路由不知道是否承担TCP连接
* 功能：基于端口的复用和分用功能
### 协议：
#### 传输控制协议TCP：全双工可靠信道，慢，差错报告
* 万维网http，电子邮件SMTP，文件传输FTP
* 面向连接：只能点对点传输，点称作socket（套接字，插槽，后文均使用插槽这个直译）
    * socket = IP:端口，TCP::={socket1，socket2}
    * socket的其他含义：应用编程接口
* 面向字节流：接受进程的数据按字节为基本单位处理——按字节塞入缓存，根据已设定的规则发送报文（肯定加了首部）
* 20B固定首部：
    1. 16b源端口，16b目的端口，
    1. 32b序号：初始字段+数据长度+报文段序号
    1. 32b确认号：期望的下一个报文段字号
    1. 16b数据偏移（数据部分距离开头的距离）
    1. 6b保留：空置
    1. 标记位：URG位：紧急数据标记，**ACK位**：确认号有效标记，PSH：尽快交付标记，RST：重连标志，SYN：同步标志（连接请求，接受请求），FIN：中止连接标志
        * SYN 攻击
    1. 16b窗口：让对方设置发送窗口的依据
    1. 16b检验和:需要12B的IP首部
    1. 16b紧急指针：紧急数据长度（紧急数据再数据的最前面）
    1. 选项字段+填充（保证4B长度的整数倍）：窗口扩大，时间戳选择确认
    
* 连接管理：有限状态机
1. 建立:又称握手,3个报文
    * 客户端主动打开插槽,服务器被动打开
    1. 客户端SYN=1,Seq=x
    1. SYN=1,ACK=1,ack++,Seq=y
    1. 客户端ACK=1,ack+=y,seq+=x,服务器认定连接建立
1. 传输:bingbingbongbong
1. 释放:4个报文
    1. 客户端主动关闭，进入等待I：FIN=1,seq=u
    1. 服务端确认关闭，临终关怀：ACK=1,seq=v,ack=u+1,C->S  
        此时客户端进入等待II，接收最后的包
    1. 服务端讲完了，等待确认：ACK=1,FIN=1,seq=w,ack=u+1   
        确认完了就关闭
    1. 客户端确认关闭：ACK=1,seq=u+1,ack=w+1
        等待2MSL再关闭客户端,保证最后一个报文传输到位
    * 2小时保活
#### 停止等待协议SW
在不可靠网络上实现可靠传输——传输无差错，接受及时处理
* 核心：**接收到上一个分组的接受确定后再发送下一组**
* 出现差错：  
分组丢失/延迟：接受方不回复，发送方**超时重传**。校验失败丢弃  
确认丢失/延迟：分组和确认加编号。不对的就丢弃
* 属于自动重传系统ARQ
* 信道利用率低：发送时长+一来一回传输时长+等待时长
* 解决办法：流水线传输
* 通信较差时大幅影响传输  
* 默认逐个确认
> **这一部分编得一坨，毫无逻辑**  
> 由ddy-ddy/cs-408 整理而来  
> 菜就多练，输不起别玩  
1. 升级版I：回退协议GBN
    * 发送窗口>1,接收窗口=1
    * 发送窗口内无需确认即可发送，接收窗口只接受窗口内的帧
    * 累计确认：确认意味着接受该帧及以前的所有帧
1. 升级版II：选择重传协议SR
    * 发送窗口>1,接收窗口>1
    * 发送，接收窗口同上。
    * 对于接收窗口，不考虑接收顺序
    * 合并确认：同上  
    这意味着如果一连串的发送中只丢失了一个，那么返回的确认编号是丢失帧的上一个  
    发送方会发送确认号的下一个，接收方返回的是完整的确认
1. 旧版留档，谁爱看谁看
    ```
    * 发送窗口：发送后确认前窗口后缩，确认后窗口前伸  
        * 发送缓存：应用给TCP的，TCP已发出未确认   
    * 接收窗口：接收正确，窗口向前滑动  
        * 接收缓存：按序到达的但尚未被应用程序读取，不按序到达的数据
        * 选择确认SACK：缺少数据块（字节块边界不连续）时要求重传缺失数据
            * 可选项：需要额外携带字节块边界，至多4个字节块的信息
            > 两个窗口间的大小可以不同  
            > 双工时接收方可以将确认信息捎带上  
            * 流量控制：控制窗口大小
                * 流水线传输中接收方可以在确认信息上携带接受窗口大小，表明自己还有报文要传
                * 死锁：如收窗口向已接收到0窗口的发送窗口发送的非0窗口报文丢失，双方都在等
                    * 解决：持续计数器——收到零窗口的一方定时发送一个探测报文
            * 提升有效传输——Nagle算法：先发缓存数据第一个字节，接收到确认后将缓存数据组装后发送。否则在达到一半容量/最大报文容量时再发送
                * 避免糊涂窗口综合征——20B IP首部+20B TCP首部，但只带一个1B数据
                * 如果接收方缓存淤积而且处理过慢，每次处理接收方窗口会发送更新报文，导致发送方发送Nagle算法的试探会塞满接收方缓存
                    * 解决办法：降低更新报文的发送优先级
    ```
* 重传问题：延迟不稳定
    * 自适应算法
        1. 加权平均往返时间：$RTT_{s} = (1-\alpha)RTT_{old}+\alpha RTT_{new}$ 
            * $\alpha$:参数，控制更新速度,一般为1/8
        1. $RTT_{D} =(1-\beta)RTT_{D_old}+\beta \mid RTT_{s}-RTT_{new} \mid$
            * $\beta$:参数，控制更新速度,一般为1/4
        1. 超时重传时间：$RTO = RTT_{s} + 4RTT_{D}$
        * 重传的报文段不计入往返时间样本，但会增大RTO：$RTO_{new} = \gamma RTO_{old}$
            * $\beta$:参数，控制更新速度,一般为2

#### 拥塞控制
不同于流量控制面向点对点，拥塞控制面向全局控制
* 开环控制：考虑周全，尽力避免
* 闭环控制：根据当下决策控制
    * 决策因素：因缓存溢出被丢弃的分组；队列长度；超时重传分组；分组延迟
    * 控制方法：位置检测；状态传递；控制传达
    * 思路：增加资源，减少需求
* TCP控制方法：基于窗口的闭环控制，发送方位处拥塞窗口cwnd会根据拥塞情况调整窗口大小  
    实际大小：min（拥塞窗口，发送窗口）
    * 判断方法：重传定时器超时，收到重复接收确认（可能拥塞）
    1. 慢开始：一个很小的拥塞窗口，未超时报文使得门状态阈值ssthresh前翻倍，
    1. 拥塞避免：cwnd在达到阈值后转为线性。检测到拥塞便将阈值设为拥塞窗口一半，拥塞窗口重置
        * 使得占用为非线性增长
    1. 快重传：收到3个连续的确认报文就重传（要求接收方立即确认，出现差错重复确认已收到的报文）
    1. 快恢复：收到3个连续的确认报文时，阈值为拥塞窗口的一半，拥塞窗口设为阈值，立即线性增长
    * 加法增大，乘法减小——AIMD算法
* 主动队列管理AQM：路由处理过慢会导致超时，误判为拥塞
    * 路由器队列；先进先出队列，末尾丢弃（会影响到很多TCP连接进入慢开始，导致全局吞吐振荡）
    * 在缓存将要满时主动丢弃分组
        1. 随机早期检测RED：快满不满时随机丢弃，将满时必定丢弃

#### 用户数据报协议UDP：不可靠信道（尽力交付），无连接，快，没有报错  
* 面向应用层报文（不做额外处理）：上面来多少就塞多少，网络层IP会拆分成片
* 没有堵塞，交互通信完善（不同于TCP）
* 首部开销小：2B源端口，2B目的端口，2B长度，2B检验和
* 常见：域名解析服务DNS，动态主机配置DHCP，路由选择RIP
* 在IP的基础上增加少量功能：
    * 复用与分用：基于端口分用，
    * 差错检测：将首部，数据，IP首部的部分内容（32b源IP，32b目的IP，8b零填充，8b代表17，16b的UDP长度）也会参与检验——2B为单位相加，检验和是其反码

## C6 应用层
应用层的许多协议都是基于客户服务器方式
### 域名系统 DNS
* 引入：应用层上不使用ip地址进行连接，使用分布式的DNS域名服务器将网址转为ip后再进行连接
* 域名： 任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构的名字
    * eg：apple.com.cn, [三级域名].[二级域名].[顶级域名]
    * “点”和点分十进制 IP 地址中的“点”并无一一对应的关系。
* 域名服务器：
    * 有限范围：区
    * 层级结构：根域名（域） -> 顶级域名（区） -> 权限域名（二级域名，区）
    * 高可靠：主域名服务器和辅助域名服务器之间定制同步，13台根域名服务器
    * 高速缓存：加快查询
    * 解析过程：  
    主机向本地域名服务器——递归查询：没查到就问其他服务器  
    域名服务器间——迭代查询：最终结果或者下一个应寻找的域名服务器
### 文件传送协议 FTP
是互联网上使用得最广泛的文件传送协议，屏蔽了各计算机系统的细节
* 客户-服务器模式。TCP可靠传输
    * 工作方式：打开熟知端口21，等待请求，处理请求，继续等待
    * 端口：控制21，数据20
    * 传输模式：ascii文本/bin二进制
    * NFS：只传输修改内容
* 简单文件传输协议TFTP
    * 客户-服务器模式。UDP不可靠传输，存在校验
    * 简单首部，每次512B数据
    * 类似于停止等待协议：每次传输需要确认，否则重传
    * 熟知端口69，以非512B数据为结尾
* 远程终端协议 TELNET
    通过TCP远程控制电脑
    * 很少使用，但仍然存在于windows功能中
    * 命令与按键转为NVT格式传递
### 万维网 WWW
一般意义上的网址
* 超媒体：超文本扩展——现代网站，提供文字，图像，音视频
* url：统一资源定位符Uniform Resource Locator
    * 格式：<协议>://<主机>:<端口>/<路径>
        1. 协议：ftp，http，news
        1. 主机：存放资源的主机域名
        1. 端口/路径：可省略，http默认80
* 实现超链连接：http协议
    * 工作过程：服务器持续坚挺TCP端口，如果有请求就建立连接，客户端发送页面请求，服务端返回请求的页面，释放TCP连接
    * 持续连接：http/1.1支持，不会立即释放连接
        * 停止等待协议/流水线
    * 代理服务器：万维网高速缓存，代表服务器返回数据，当然也可以作防火墙
* 页面显示：超文本标记语言 HTML HyperTextMarkup Language
    * 类xml
    * 链接：远程/本地
    * XHTML：更严格的
    * 层叠样式表CSS Cascading Style Sheets
    * 静态/动态文档：被用户申请时在服务器上的表现不同，一个不变一个改变
* 机制扩充：通用网关接口——CGI双方增加一个应用去处理对方的控制
    * 脚本，被其他程序利用
    * 活动文档：直接发给客户端自己用——java
        * 组成：程序语言，运行环境JVM，类库
* 信息检索：搜素引擎
    * 全文搜索（百度，谷歌）分类目录搜索（雅虎，新浪）垂直搜索（特定）
    * 博客（不符国情）
    * 社交网络
### http报文
请求报文
1. 开始行：方法[空格]URL[空格]版本[\n]
1. 首部行*n：key:value[\n]  
1. 实体主体  
响应报文  
1. 开始行：版本[空格]状态码[空格]短语[\n]
    * 状态码：404
        1. 通知信息的
        1. 成功
        1. 重定向
        1. 客户差错
        1. 服务器差错
1. 首部行*n：key:value[\n]  
1. 实体主体
* cookie:服务器和客户之间传递的状态信息,可跟踪

### 电子邮件
组成：
1. 用户代理：电子邮件客户端软件
1. 邮件服务器：发送和接收邮件（同时充当客户和服务器），同时还要向发信人报告邮件传送的情况
1. 邮件发送/读取协议：均为TCP
    * 简单邮件发送协议SMTP，发信与传递，端口25
         * 缺点：只能传7b ascii码，不能过长
    * 通用互联网邮件扩充 MIME——对SMTP的扩充：新编码，扩展首部（版本+编码+内容类型）
    * 邮局协议POP3/IMAP：收信，POP3的管理操作仅客户端，IMAP同步
    * 格式：
        1. 信封
            * From To（邮箱名@邮箱主机域名）一或多
            * Subject：主题
            * Cc：邮件副本
            * Data：日期
        1. 内容： 纯文本

### 动态主机配置协议 DHCP
赋值给IP，子网掩码，默认路由IP，域名路由IP
* 使用客户-服务器模式：向DHCP服务器发现报文，服务器返回提供报文，服务器端口67，客户端口68
* DHCP中继代理：代转发现报文与提供报文
* 租用期：分配的ip是临时的，发送释放报文
### 简单网络管理协议 SNMP
* 功能：故障管理，配置管理，计费管理，性能管理， 网络安全管理
* 客户（被管设备）-服务器（管理站，管理员）模式
    * 代理：在被管设备上执行管理站命令，即客户端
    * 尽可能简单
    * 代理：使用其他协议控制被管设备，管理站通过SNMP控制代理
* 组成：
    * SNMP，使用UDP
        * 探询，陷阱
    * 管理信息结构SMI：命名，数据类型，编码，使用抽象语法记法
    * 管理信息库 MIB：在被管理的实体中创建了命名对象，并规定了其类型

### 应用进程跨越网络的通信
**略**
### P2P 应用
**略**

## C7：网络安全
### 概述
1. 被动攻击：截获
1. 主动攻击：篡改，恶意程序（木马，病毒等），拒绝服务（DDoS）
1. 保护目标：保密（仅发送和接受才明白），身份鉴别，信息完整，运行安全
* 数据加密：密钥，加密算法，解密算法
    * 密码学：密码编码学，分析学
* 无条件安全：即使算法公开，不能只通过密文破解

### 密码体系
* 对称密钥：加密解密使用相同密
    * DES标准：64b一组进行加密，密钥56位+8位校验
    * 不安全：保护密钥，可破解
        * 三重DES：加密-解密-加密
    * 一对一保密
* 公钥密码：不同的加密密钥和解密密钥
    * 加密为公钥，可以公开，解密私钥，需要保密；  
    私钥由公钥生成，但不能逆向；  
    * 一对多保密
### 数字签名
基于公钥密码体系：私有密钥加密，公开密钥解密
* 保证以下：证明来源，完整性，防伪造
### 鉴别
### 密钥分配
### 互联网安全协议
### 防火墙