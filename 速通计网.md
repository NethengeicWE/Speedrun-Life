# 计算机网络速通
## 前言
* 坏消息：还是计网的那个老师
* 好消息：熟练多了
* 坏消息：这是她第二次讲这门课
* 好消息：教材也是一坨，现实的网络架构也是一坨
* 不用背首部格式：考研题会给
    > 如果她没给，**我[优美的中国话]**
> 2025.3.8 开始基于原课程上补充以适应408

## C0：概括
从下到上：物理，链路，网络，运输，应用
1. 应用层-**插槽socket**，应用层协议——DNS，http，SMTP（电子邮件）  
    * 
1. 运输层-**TCP/UDP协议**：首部+[上层数据]
    * 拥塞控制（端到端），流量控制（全局）
1. 网络层-**ip数据报**：首部+[上层数据]
1. 链路层-**以太网mac帧**：mac目的地址，mac源地址，[上层数据]，帧结束
1. 物理层：7B同步码（1010101...）+ 1B帧开始（10101011）

* 首部内容：必带源地址和目标地址，不同的首部不同的协议，如版本，协议，数据长度和校验，标记等
* 往下看是封装好的函数，只负责调用；往上看是实现功能

## C1：概述
### 1.1 分类
* 互联网组成：
    * 组成部分方向：硬件，软件，协议
    * 工作方式方向：边缘部分与核心部分
    * 功能方向：通信子网（传递数据，控制）与资源子网（共享计算资源/存储的数据）
* 功能：
    * 数据通信
    * 资源共享：软件，数据，硬件
    * 分布式处理
    * 高可靠
    * 负载均衡
* 核心技术：交换技术
    * 电路交换：通过转接电话线实现直连
        * 一对一直连---时延小，有序传输，无冲突，简单控制
        * 物理信道---建立连接慢，线路利用率低，不灵活，没有差错控制
    * 报文交换：直接包装发送的数据，通过相邻节点的转发来抵达目的
        * 临节点---不用建立连接，动态规划，多线路利用
        * 多节点---转发时延，缓存开销
        * 不处理数据---差错问题
    * 分组交换：在报文基础上将大数据分装成小份再发送
        * 优点同上
        * 小数据包---更高效的线路利用，缓解节点压力，差错影响
        * 更多的包装---传递额外信息，时序
* 拓扑结构分类：总线，环形，网状，星型
* 使用者分类：公用网，专用网，接入网（将用户接入互联网）
* 以作用范围分类：
    1. 广域网：数千公里
    1. 城域网：50km
    1. 局域网：1km
    1. 个人局域网：10m
    1. 多机处理系统（不算网络）：多机处理系统
* 传输介质：有线（双绞线，同轴电缆，光纤）无线（蓝牙，微波，无线电）
* 性能指标：以水管举例
    * 速率：水流量
    * 带宽：管子直径---最大速度/信号频率
    * 吞吐量：一定时间流出流入的水的体积
    * 时延：水从一段跑到另一端所需时间 = 发送速度+传输速度+中转处理（排队+处理）速度
        * 时延带宽积：当数据到达终点时总共已发送的数据   
        * **往返时延Round-Trip Time-RTT** ：从发送端发送分组到接收来自接收端的确认的时间
    * 非性能指标：费用，质量，标准化，鲁棒性，可维护性

### 1.2 **体系结构**：
* 基本原则：
    1. 每层实现一种相对独立的功能
    1. 层间接口清晰，相互交流少
    1. 下层独立于上层，上层单向利用下层服务
    1. 只关心要求，不关心实现
* **协议**：事先约定好数据格式等相关问题---语法，语义，时序
    * 每一层都使用相同的数据单元，即PDU，包含服务数据单元SDU（数据）和协议控制信息PCI（数据头）
* **接口**：同一层次实体间的交流的出入口
* **服务**：功能调用
    * 四类原语：请求-指示，响应-证实 ？？
    * 分类方式：面向连接/无连接，可靠/不可靠，有应答/无应答
* 各层相对独立，仅为向上/向下负责——水平协议，垂直服务
* TCP/IP模型：网络接口（1，2），网际层ip（3），运输层TDP/UDP（4），应用层http，dns等（5，6，7）
* OSI模型：服务-协议-接口
    1. 物理层：bit，定义终端与通信的物理与逻辑连接
    1. 数据链路层：帧，管理物理介质传输---帧封装解封，mac寻址，错误检测纠正，冲突检测
    1. 网络层/网际层：数据报，确保端到端传输---路由选择，ip寻址，分组转发，拥塞控制，差错控制
    1. 运输层：段（TCP），数据报（UDP），保证点对点传输---可靠传输，多路复用，错误检测，连接管理，安全管理
    1. 应用层：
        1. 会话层：逻辑链路管理
        1. 表示层：数据结构转换，加解密
        1. 应用层：用户与网络的接口
    * 差别：现有osi再有TCP/IP，前者更通用，后者更广泛
> 符号问题
> 速率表示时：k-M-G-T,1000为单位
> 存储表示时：k-M-G-T,2^10= 1024为单位


## C2 物理层
### 2.1 定义
* 只关心bit流传输，规定接线器物理规格，电压范围，功能特性
* 术语：连续信号/模拟信号，离散信号/数字信号，参考DSD
* 数据通信系统：源系统，传输系统，目的系统
* 速率：波特率/比特率，一个按码元算，一个按二进制算
* 信道Channel：以交互信息分类——单向（单工），双向交替交通（半双工），双向同时通信（全双工）
    * 信道的极限频率：信号受干扰使得码元间隔模糊，即码间干扰  
    * 香农公式：$C = W\log_{2}(1+S/N) bit/s$
    * 奈奎斯特公式：$C = 2Wlog_2 N$
    * 信噪比：信号平均功率与噪声平均功率之比 = $10\lg(S/N)$
* 对基本频带信号的调制与解调：也可称为数字信号编解码
    * 方式：调幅——振幅，调频——频率，调相——相位差
* 编码方式
    * 不归零：默认
    * 归零制：正脉冲为1，负脉冲为0
    * 曼彻斯特编码：采样周期间上越变为0，下越变为1（始终代表下一个周期数字）    
    **0上1下，间隔** 
    * 差分曼彻斯特编码：采样时越变为0，没有越变为1（始终代表下一个周期数字）  
    **0变1不变，采样**
### 2.2 传输媒体
1. 导引型传输媒体：双绞线，同轴电缆，光纤
1. 非导引型传输媒体：无线传输
### 2.3 物理层设备
* 中继器：整形，放大，转发信号
* 集线器：多端口中继器


## C3 数据链路层
### 3.1 功能
* 主要任务：在一段链路上传递帧
    * 链路管理：建立连接，维持和释放
    * 透明封装：一段数据前后会添加首部和尾部，数据中与标志位相同时不会影响传输
        > |标志|地址|控制|信息|检验|标志|
        > |-|-|-|-|-|-|
        > |01111110| 8bit | 8bit | N位可变 |16bit | 01111110 |
    * 流量控制：限制发送方速度，使得接收方能及时处理避免溢出    
    OSI体系中规定链路层也会有流量控制，在TCP/IP体系中转移至传输层（TCP/UDP）
    * 差错检测：帧中的bit可能翻转，帧丢失，帧重复  
    **不使用确认重传，仅丢弃差错帧**
* 基本概念：
    * 链路：一个节点到相邻节点的物理线路
    * 数据链路：在链路的基础上增添通讯协议
    * 帧：协议数据单元
* 服务提供：有/无确认的无连接服务，有确认的有连接服务
    * 确认：目标主机收到帧后需要返回确认
    * 连接：发送帧之前是否需要建立链路连接。

### 3.2 组帧（封装成帧）
* 帧定界：
    * 字符计数法：首部有一段记录帧长度（字节为单位，包括本体）
    * 字节填充法：使用特定字节标记头与尾，数据字段中如果包含该特定字节，需要添加转义符号避免误触
    * 零比特填充法：使用01111110标记头尾，数据字段中每五个1，后面插入一个0避免误触
    * 违规编码：在曼彻斯特编码中，高-高与低-低电平对违规，但可作为定界符

### 3.3 差错控制
* 差错控制分两种：自动重传ARQ，前向纠正FEC
* 检错校验：
    * 奇偶校验：只需一位检验位，标记1的个数。只能检查是否出错，可能无法检验出
    * 循环冗余校验：双方约定一个定值，校验码是数据段除以定值，检验时数据连校验码一起除以定值，没有余数即无差错
    > 除法进行位逻辑异或
* 纠错编码：海明码
    1. 检验码插入在$2^n$上：1，2，4，，8，16…
    1. 插入后形成新的位数，每个非检验位的位数决定了由哪些检验位检验
        * 比如第7位的数据由1，2，4位的海明码检验：7 = 1+2+4
    1. 检验位范围内的数据做异或
    1. 检验原理：每个检验位与范围内做奇偶校验，校验后的数据为出错位数

### 3.4 流量控制
* 数据链路层：控制相邻节点的流量，接收方溢出不返回确认
* 传输层：控制端到端流量，接收方的确认报文可以调整发送方窗口
* 停止-等待控制方法：发送一帧后只有接收到确认才发下一帧
* 滑动窗口控制：发送方和接受方均维持一组特定序列
    * 发送方：序列中可以无需等待直接发送，已经发送不会二次发送，收到已发送帧的确认窗口往后移动
    * 接收方：只接受窗口内的帧，确认接收后窗口往后移动
* 可靠传输机制：
    * 基本机制
        1. 帧编号：标记帧的序列号
        1. 确认机制：接收方发送ACK通知发送方成功接收该帧  
        为了降低开销，允许接收方合并确认确认编号，此时ACKn代表确认n及之前的帧确认接收
        1. 定时器：发送方发送一帧后会启动计时器
        1. 错误处理：
    * 停止-等待Stop-and-wait：即停止-等待控制方法，发送接收窗口大小为1
    * 后退go-back-N：允许发送窗口大于1，发送的N个帧中有一个帧确认超时，则窗口回退到超时帧进行重传
    * 选择重传selective-repeat：允许发送接收窗口大于1，只有接收窗口全部确认才移交上层并窗口后移  
    此时接收方的校验错误可以发出否定帧NAKn，发送方接收到后立即重传
* 信道利用率分析：发送时间占据动作周期的时间

### 3.5 介质访问
* 信道复用：两端架设复用器与分用器：仅需一根线即可承担多根线的任务  
    > 复用：承担多种用途  
    * 频分复用FDM：划分总频带
    * 时分复用TDM：划分时间片，根据复用器输入动态规划时间分割方式成为异步时分复用
    * 波分复用WDM：不同频率的光
    * 码分复用CDM：使用-1和1表示代替0和1，多位bit代表某一个输入端的1bit，该多位bit称为码片。要求不同码片的内积为0，用于自己的内积为1
        * 内积：相同位置的数字相乘，积相加
        * 数据集中：直接相加，没有上限
        * 数据分离：叠加信号与码片序列内积---$\frac{1}{N}\sum_{i=1}^{n}R_i\cdot C_i$
* 随机访问介质访问控制协议---信号冲突与争用
    * ALOHA
        * 纯ALOHA：不检测就发送，直到发送成功
        * 时隙ALOHA：规定时隙，站点只能在时隙开始时才能发送
    * CSMA：载波监听多路访问Carrier Sense Multile Access
        * 1-坚持CSMA：直到信道空闲才发送
        * 非坚持CSMA：站点发送数据时监听信道，若信道繁忙，随机时间后监听
        * p-坚持CSMA：仅适用时分信号---站点发送数据时监听信道，若信道空闲，以p概率发送，1-p概率推迟到下一个时隙
        * CSMA/CD：至多1RTT发送方知道自己发送的信号受到干扰（信号叠加超出阈值）
            * 如果发送帧过短，则无法确认，保证最短帧长=RTT*信道带宽
            * RTT内没有检测到干扰，则认定这次发送没有干扰
            * RTT内检测到干扰，则$random(0,2^n -1)*RTT$时间后重传
            * 强化碰撞：检测到冲突发出认为干扰信号
            > 10Mb/s，最小时间片51.2us，百兆更小
            * 载波延伸：MAC帧不足512B时填充字符以确保最短帧64B，争用时间512B
            * 分组突发：大量短帧发送时只需要第一个帧填充
        * CSMA/CA：冲突检测在非导引型介质中效果不佳，故改为冲突避免
            * 使用ARQ为SW
            * 如果信道空闲，在一个时隙后发送，否则随机时间等待后再发送
            * 针对不了解信道上的设备，发送方会发送一个RTS帧（Request to Send）请求对方预留信号，接收方回复CTS（clear to send）确认信号预留，其他设备收到不是自己的RTS和CTS会推迟自己的发送  
* 轮询访问：令牌传递协议
    * 在环形拓扑/总线拓扑中通过中控主机控制网络传输
    * 主机发送空令牌，需要发送的数据只能在获得令牌后填入令牌，再发送
    * 总线上设备检查令牌是否是自己的，否则转发
    * 发送方接收到自己填写的令牌，检查是否有差错，否则重传
    * 适合高负载信道，尽量避免冲出
    * 优先级机制

### 3.6 局域网
* 定义：较小范围内由引导介质组成资源和信息共享的计算机互联网络
    * 有限的地理范围和节点数量，高速率低延迟
    * 拓扑方式：以太网，令牌环，FDDI
    * 有限层：物理层与数据链路层，链路层又分为逻辑链路和介质访问链路
* MAC：物理硬件地址，生产时固化在ROM中，  
高3位字节为厂商，低三位字节由厂商决定，
* 以太网：目前最流行的有线局域网技术
    * 简化通信：无连接，不可靠服务，曼彻斯特编码，码元通过电压转换区分
    * 传输介质：粗/细同轴电缆，非屏蔽双绞线，光线对
    * 计算机通过网络适配器实现连接，适配器每收到一个帧时先检查是不是给自己的
        * 单播帧（终点站），广播帧（发给本局域网所有站点），多播帧（部分站点）
    * 以太网MAC帧：介绍Ethernet V2标准
        1. 物理层：
            1. 7Btye 前同步码
            1. 1Btye 帧开始定界符
            1. MAC帧：
                1. 6Btye目的地址（物理地址）
                1. 6Btye源地址（物理地址）
                1. 2Btye类型：交给哪个上层协议处理
                1. 46~1500IP数据报
                1. 4Btye FCS校验序列，不包括同步码与定界符
        * 不需要结束定界符：帧之间存在间隙，使用违规编码区分码元
* 无线局域网：
    * 固定基础设施：预先建立的基站，使用802.11标准
        * 星型拓扑，中心接入点称为AP，需要标识符SSID
        * 最小构建：基本服务集BSS：Basic Service Set，任何通信必须经过AP
        * 多个BSS可做成ESS
    * 无固定基础设施移动自组织网络
        * 节点间平等，都具有路由功能
        * 发现新设备，自动组网
    * 局域网MAC帧：**复杂首部**
        1. 2Byte帧控制：协议版本，类型，子类型，**是否去往AP**，**是否来自AP**，更多分片，重试，功率管理，更多数据，WEP，顺序
        1. 2Byte持续期
        1. 6Byte地址1
        1. 6Byte地址2
        1. 6Byte地址3
        1. 2Byte序号控制
        1. 6Byte地址4：站不考虑
        1. 0-2312Byte帧主体
        1. 4Byte FCS
        * 前三个地址的含义：
            * 来自AP：目的地址-自己AP地址-源地址
            * 去往AP：AP地址-源地址-目的地址
### 3.7 广域网
* PPP协议
    * 需求：简单，易操作；帧封装；透明性；多重网络协议支持；多类型链路支持；差错检验；连接检验；最大传输……
    * 组成：封装ip数据报的方法；链路控制系统；网络控制协议
    * 工作状态：链路建立（通过ppp发送lcp分组），LCP配置和协商，鉴别，打开
### 3.8 设备
* 网桥：简单的识别帧和转发帧，不会连接冲突域  
早期的数据链路层设备，现以取代
* 交换机：
    * 多接口网桥，共享带宽
    * 自学习功能：记忆物理端口连接设备的MAC地址，若没有则广播
    * 直接交换/存储交换

## C4 网络层
### 4.1 功能
* 异构网络互联：网络的拓扑结构，寻址，校验等均不同，但他们连结在一起并正常工作
    * 物理层中继器：转发器，集线器
    * 数据链路层：网桥/交换机
    ---
    * 网络层中继器：路由（历史包袱：网关）
        * 路由器：路由选择，分组转发
    * 网络层以上：网关
    > 低于网络层的中继通过IP协议统一，不视作扩大网络
* 网络层服务：
    * 虚电路：建立逻辑上的直通电路，有对应的物理路径
        * 流程：连接请求，确认请求，传输数据，释放请求
        * 优点：提供可靠通信，数据报小
        * 缺点：建立与释放开销较大，节点故障则直接失效
    * 数据报：无需建立连接，报文拆分成分组，由中间节点决定下一站
        * 流程：主机将分组发送到最近的节点，节点间根据自己维护的转发表转发分组，节点间确认传输
        * 优点：无需建立连接，更灵活，鲁棒性
        * 缺点：不保证可靠性
* SDN：软件定义网络Software Defined Network
    * 特点：将网络层细化为转发和控制，由中央控制所有节点的转发
    * 从分布式变为集中控制，仅针对特殊场景
    * 面向开发者：北向接口，面向硬件：南向接口，如openflow
* 拥塞控制：针对网络全局
    * 判断方法：随着网络负载增加，吞吐量没有正常增加
    * 涉及网络中所有的主机和路由，不能通过单一增加资源改善
    * 控制策略：预设的开环控制，检测网络的闭环控制

### 4.2 IPv4
* 格式：  
    首部20B+数据
    > 如果需要使用，考试会直接给出格式，不必强记
    * 固定部分：
        1. 4b版本：ipv4/ipv6，默认为4
        1. **4b首部长度**：以4B为单位，默认为5
            > ip首部往往是0x45，可用作定位
        1. 8b区分服务：不使用
        1. **16b总长度**：首部+数据，最高为64k=65535
        1. 16b标识：标记同一个长数据报的不同分组
        1. **16b片标记**：
            * 第一位无意义
            * DF：不要分片Don’t Fragment
            * MF：还有分片More Fragment
            * 13b：片内偏移，以8B为单位
            * 超大数据会被分割为多个IP数据报，称为片
            * 为社么要数据报分片：不同子网的链路层帧的最大传送单元MTU不同
        1. 8b生存时间：最大路由通过数
        1. 8b协议：该数据应交给哪个上层协议：TCP（6），UDP（17），ICMP，IGMP，OSPF
        1. 16b首部检验和：检验首部数据，不采用CRC
        1. **32b源IP地址**
        1. **32b目的IP地址**
    * 可变部分：可选字段，填充
    
* IPv4地址：网络层上为没他主机/路由分配唯一的32位标识符
    * 分类方式：
        1. A类（1-126）2^7-2：1B网络号，3B主机号
        1. B类（128-191）2^14：2B网络号，2B主机号
        1. C类（192-223）2^21：3B网络号，1B主机号
        1. D类（224-239）：多播地址
        1. E类（240-255）：保留使用
        * 类别分类：由网络号决定
    * 特殊IP：
        * **主机号全0**：子网络本身(A类少一)
        * **主机号全1**：子网广播地址
        * 127.xxx：主机本身(A类少一)
        * 全0：本网络上的本主机
        * 全1：等效广播地址
    * 子网划分：从主机号借用若干位作为子网号
        * 子网掩码：表明子网划分位数，通过作位与运算转化
        * 定长子网划分：每个子网ip数量相同（子网掩码等长），比较浪费
        * 变长子网划分：每个子网ip数量不同（子网掩码改变），更为精细，但是同ip对应不同子网的地址
        * 无分类编址CIDR：灵活主机号位数，使用子网掩码格式表示划分方式
        * 路由聚合：在路由表中通向同一个路由的不同目标ip地址可以以子网掩码的方式聚合  
        在寻找下一跳的地址时优先使用子网掩码最大的地址（更详细）
    * 网络地址转换NAT：专用网络和公用网络间的IP地址转化
        * 私网可使用：  
        A：10.xxx.xxx.xxx  
        B：172.16.xxx.xxx到172.31.xxx.xxx  
        C：192.168.xxx.xxx  
        * 工作原理：从公用网络角度看，路由的socket对应专网ip
        * VPN：利用公用互联网作为各私有互联网间的通信载体
            * 使用隧道技术，打包数据报，可以加密保证安全
            * 内联网，外联网：两部门之间，第三方参与
            * 远程接入VPN：公司外的员工访问公司网络
* 分组转发：**每个路由维护一个跳转表**：（目标地址，下一跳地址），根据报文的目标地址转发到下一跳地址
    * 默认地址：0.0.0.0/0，如果没有则走默认路由
* 地址解析协议ARP：从ip地址获得mac地址
    * 链路层不关心上层协议（即ip）的具体内容
    * 通过ARP，IP地址映射到MAC地址来包装MAC帧  
    * 每个主机都有一个ARP高速缓存存有该映射，如果没有映射则向局域网广播
        * 请求报文中的mac地址为全f
        * 尽管处理了mac帧，因为触碰到了ip，所以视作网络层
    * 跨局域网处理：目标ip不变，但是每一次的节点跳跃都会改变mac地址
* 动态主机配置协议DHCP：允许一台新加入的计算机自动获得ip地址
    * 使用Server/Client模式：在新网络广播发现报文，但只有DHCP服务器回应并携带ip地址
        * 应用层协议，因为使用S/C模式
    * 多台DHCP服务器，存在先后顺序。故接受新ip需要广播确认
* 网络控制报文协议ICMP：允许主机报告差错与异常
    * 8b类型，8b代码，16b校验和：
        * 差错报文：终点不可达，超时，参数问题，重定向
        * 询问报文：回送/回答报文，时间戳请求/回答报文
    * 32b取决于类型。数据部分
    * 不发送ICMP：本身，带片偏移（只报告第一个），多播，特殊地址
    * 应用：ping

### 4.3 IPv6
* 背景：深厚历史的IPv4的32位地址已经耗尽，使用128位的IPv6地址毫无后顾之忧
* 改进：
    * 更大的地址空间与层次方式
    * 首部定长（40B），但允许协议扩展
    * 即插即用，安全保证  
    * 可以预分配资源保证低延迟高带宽
    * 只有源主机才能分片
* 结构：  
    1. 4b版本 
    1. 8b通信量类：区分数据报类别与优先级 
    1. 20b流标位：相同的始终点具有相同的标号
    1. 16b有效载荷长度：除首部以外的数据，最高64kB
    1. 8b下一首部：表示数据报内容形式，如果有扩展首部便表示第一个扩展首部类型
        * 分类：逐跳选项,路由选择,分片,鉴别,封装安全有效载荷,目的站选项
    1. 8b跳数限制：字面意义
    1. 128b*2源地址和目的地址
        * 目的地址：单播，多播，任播（交给目的站一堆计算机中最近的一个）
* 地址表示：16进制，隔4插冒号，至少有一个数字
    * 简化表示：全零的值域使用::省去
    * 特殊分类：
        * 全0：未指明地址
        * 全0，只有低位为1：环回地址
        * 前8位为1：多播地址
        * 前10位为1SS：本地链路单播，类似于ipv4私有地址
    * 128位地址足以容纳64位mac地址
* 向下兼容：
    * 双协议栈：同时处理ipv4和ipv6
    * 隧道技术：将v6数据报封装成v4数据报
* ICMPv6
    * ARP和IGMP合并到ICMPv6中
    * 新增报文类别：邻站发现报文ND，组成员关系报文MLD

### 4.4 路由器
* 路由算法：给定一组路由器与其链路，寻找从源路由到目标路由的最佳路径
    * 静态：手动配置路由表
    * 动态：根据流量负载和拓扑结构变化动态调整
    * 距离-向量算法：最短路径上的每一段都是节点间的最短路径
        * 路由器定时向邻居发送距离向量副本，自己接送其他并更新
    * 链路状态路由算法：每个节点具有全网的拓扑结构，通过Dijkstra计算最短路径
        * 主动测试相邻节点并定时传播
        * 易于查找故障
* 分层路由协议：互联网极大规模，但不是所有人都想公开
    * 自洽系统：对内可以乱搞并保证隐私，但对外可作为一个整体同等处理
        * **路由信息协议RIP**：网络中每一个路由都维护着自己到其他每个目的网络的距离记录。  
            * 与**相邻路由**固定间隔交换自己的路由表，收敛速度快。  
            > 这里的距离指的是经过的路由器数量，最多15跳，只会记录一条最短  
            * RIP距离向量算法：应用层协议，UDP端口520
                1. 收到RIP报文后，该报文所有目标地址的端口全部指向报文发出者，距离+1
                1. 添加目的网络（如果不存在），更新地址（不同端口相同目的，以新的为准），更新端口（相同目的且跳数更小）
                1. 三分钟没有收到更新路由表则标注位不可达路由
            * 特点：好消息传得快，坏消息传得慢：短链路信息由每次交换路由表传播，超时链路需要每个路由验证超时后才传播出去
            * 两个网络间只能使用一条线路
            * 实现简答开销小，但限制规模——15最大跳数和完整路由表
        * **开发最短路径优先OSPF**：使用Dijkstra的最短路径算法
            * 使用IP数据报，数据短，不会分片传输导致丢包重发
            * 向本区域中**所有路由器**发送信息——与本路由器相邻的所有路由器的链路状态，30分钟一次
            * 每个路由器建立一个链路状态数据库，即全网的拓扑结构，用来给路由表计算最短路径
            * 使用区域划分适应更大规模的网络，区域间只有个一路由相连
            * 可平衡路径负载，支持变长子网划分与CIDR
            * 分组类型：问候（确定可达性），数据库描述（同步数据库），链路状态请求，链路状态更新，链路状态确认（更新数据库）
    * 边界网关协议**BGP协议**
        * 环境：互联网规模极大，政治因素
        * 每个自洽系统至少需要1个路由作为发言人
        * 不同自洽系统的发言人建立TCP-BGP会话交流路由信息与网络可达性
            * 打开，更新，保活，通知

### 4.5 IP多播
* 只需一个报文就能服务多个客户，大幅减轻发送者负担
* 多播地址：IPv4 D类地址（224-239），IGMP协议，UDP协议，不需要差错报文
    * 硬件多播：将D类地址可变部分直接映射到MAC地址后半部分，指定MAC多播为01-00-5E、
* 网际组管理协议IGMP：多播路由器管理多播组
    * IP协议的组成部分
    * 新主机加入：向多播ip发送IGMP报文声明加入，多播路由向其他路由转发组成员关系
    * 保持连接：定期检查多播组是否还有成员，没有成员则不转发关系

### 4.6 移动IP
* 移动站以固定IP跨越不同站点：笔记本在办公室和家里之间不断开TCP
    * 移动节点：永久IP的移动主机
    * 本地代理：初始网络路由
    * 外地代理：新低点的路由
* 实现原理：代理转发
    * 移动站拥有一个永久地址，不会因为局部网络变化
    * 接入外地网络后外地代理会分配一个临时地址给移动站，并通知本地代理
    * 其他人不知道移动站的具体地址，但本地代理知道在哪，通过隧道技术转发，直接使用MAC地址

### 4.7 网络层设备
* 域：
    * 冲突域：物理连接节点，需要CSMA/CD，如集线器，中继器
    * 广播域：发出广播帧，其他设备能接收到的范围，包括交换机，不包含路由器（可以划分）
* 路由器：多io端口的专用计算机，用于连接不同异构网络并完成分组转发
    * 路由选择：路由选择处理器--路由表与选择协议
    * 分组转发：解析与打包，交换结构，输入输出

## C5 传输层
### 5.1 功能
* 面向通信的最高层，为不同主机的进程提供通信：
    * 逻辑通信：为主机进程提供网络服务
    * 分用与复用：不同进程使用同一个传输协议传递数据，接收方将数据正确交付给应用进程
* 面向用户最底层，保证可靠服务
    * 检错检测：对报文检验，出错则要求重发/放弃
* 端口：标识主机种的应用进程，一个主机只有一个ip地址
* 端口号：16bit，最大65536
    * 指定端口号：0-1023  
    ftp：21，TELNET：23，SMTP：25，DNS：53，HTTP：80，https：443，RDP：3389
    * 自选端口号：1024-65536
* 套接字：ip地址+端口号
* 用户数据报协议UDP：无连接
    * 多路复用，数据检查
    * 域名系统DNS，简单文件传送TFTP，路由信息RIP。简单网络管理SNMP，网际组管理IGMP
* 传输控制协议TCP：面向连接的可靠服务
    * 建立连接，确认，流量控制，计时器，连接管理
    * 简单邮件传送SMTP，电传机网络TELNET，超文本传输http，文件传输FTP


### C5.2 UDP
* 概述：在ip基础上增加复用与分用，差错检测，几乎ip没有差别
* 优点：无需建立连接，首部开销小，无拥塞控制，可以多对多。  
适用于一次少量数据，不需要可靠但延迟敏感
* 特点：可靠性机制可以自己实现；**以报文为基础单元（不可分割）**
* 格式：
    1. 16b原端口号：不需要回信则为0
    1. 16b目的端口号
    1. 16bUDP长度：最小值为8（只有首部）
    1. 16b检验和-部分IP报头部也要参与：  
    4B源IP，4B目的IP，1B为空，1B表示17，2B表示长度+UDP首部  
    将报文分成2B，不足的地方进行补0，然后进行求和

### C5.3 TCP
* 可靠传输机制：
    * 序号：字节为单位的顺序位号
    * 确认：期望对方发出的报文段的第一字节位号。  
    使用累计确认，如果中间断了则一直期望短缺部分
    * 重传：确认返回超时/接收方主动要求
* 特点：一对一，可靠交付，全双工，**字节为基础单元**
* 20B固定首部：
    1. 16b源端口，16b目的端口，
    1. 32b序号：该报文段第一个字节在总字节流的位置
    1. 32b确认号：期望的下一个报文段字号
    1. 16b数据偏移：表示数据部分在序号后的哪一个
    1. 6b保留：空置
    1. 标记位：  
        URG位：紧急指针有效标记  
        **ACK位**：确认号有效标记，  
        PSH：尽快交付标记   
        RST：重连标志  
        SYN：同步标志（连接请求，接受请求）  
        FIN：中止连接标志
        1. 16b窗口：让对方设置发送窗口的依据
    1. 16b检验和:需要12B的IP首部，与UDP类似
        * 将首部，数据，IP首部的部分内容（32b源IP，32b目的IP，8b零填充，8b代表17，16b的UDP长度）也会参与检验——2B为单位相加，检验和是其反码
    1. 16b紧急指针：紧急数据长度（紧急数据再数据的最前面）
    1. 选项字段+填充（保证4B长度的整数倍）：窗口扩大，时间戳选择确认
* 连接管理：有限状态机（seq：报文头位置）
    1. 建立:又称握手,3个报文
        1. 客户端：我要建立连接：SYN=1,Seq=x
        1. 服务器：我准备好了，你呢：  
            * SYN=1,ACK=1：请求连接，期望收到指定字节流
            * ack=Seq+1：期望下一条就是确认报文
            * Seq=y：本报文在y位置
        1. 客户端：我准备好了：  
            * ACK=1,ack=y+1：字节流分上下行，期望的包就是建立连接的第一个报
            * seq=x+1：字节流分上下行，上一个包是请求
            * 服务器认定连接建立
    1. 传输:bingbingbongbong
    1. 释放:4个报文
        1. 客户端：我要关闭连接I：  
            * FIN=1,seq=u：中止连接有效，本报文长u个字节
        1. 服务器：好的，关闭上行，还有什么要说的
            * ACK=1,ack=u+1：期望收到上个报文的后续
            * seq=v：本报文长v个字节
        1. 客户端：说完了，下行关闭：
            * FIN=1,seq=w：中止连接有效，本报文长w个字节
            * ACK=1,ack=u+1：期望收到继续关闭报文的后续
        1. 服务器：好的，关闭下行：
            * ACK=1,ack=w+1
            * seq=u+1：你想要的报文  
            等待2MSL再关闭客户端,保证最后一个报文传输到位
        * 2小时保活

* TCP控制方法：拥塞控制（点对点）
    * 与流量控制的区别：前者是全局（观察AS系统的路由），后者点对点
    * rwnd：接收窗口；cwnd：拥塞窗口
    1. 慢开始：一个很小的拥塞窗口，未超时报文使得门状态阈值ssthresh前翻倍（2^n）
    1. 拥塞避免：cwnd在达到阈值后转为线性。  
        检测到拥塞（确认超时）便将阈值设为拥塞窗口一半，拥塞窗口重置
    1. 快重传：收到3个连续的确认报文就重传期望报文
    1. 快恢复：收到3个连续的确认报文时，阈值为拥塞窗口的一半，拥塞窗口设为阈值，立即线性增长
        * 上面两个都要求接收方立即确认而不是捎带确认，出现差错意为重复确认已收到的报文

## C6 应用层
### C6.1 模型
    1. 客户/服务器模型：主次之分，明确分工，压力给到服务器
    1. P2P模型：直接通信，同等地位，压力平摊
### C6.2 域名系统 DNS
* 引入：应用层上不使用ip地址进行连接，使用分布式的DNS域名服务器将网址转为ip后再进行连接
* 域名： 任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构的名字
    * eg：apple.com.cn, [三级域名].[二级域名].[顶级域名]
    * “点”和点分十进制 IP 地址中的“点”并无一一对应的关系。
* 域名服务器：
    * 有限范围：区
    * 层级结构：根域名（域） -> 顶级域名（区） -> 权限域名（二级域名，区）
    * 高可靠：主域名服务器和辅助域名服务器之间定制同步，13台根域名服务器
    * 高速缓存：加快查询
    * 解析过程：  
    主机向本地域名服务器——递归查询：没查到就问其他服务器  
    域名服务器间——迭代查询：最终结果或者下一个应寻找的域名服务器
### C6.3 文件传送协议 FTP
是互联网上使用得最广泛的文件传送协议，屏蔽了各计算机系统的细节
* 客户-服务器模式。TCP可靠传输
    * 工作方式：打开熟知端口21，等待请求，处理请求，继续等待
    * 端口：控制21，数据20
    * 传输模式：ascii文本/bin二进制
    * NFS：只传输修改内容
    * 主动模式PORT：服务器连接客户**提供的**端口（不唯一）
    * 被动模式PASV：客户端连接服务器提供的端口

### C6.4 电子邮件
* 组成：
    * 用户代理：电子邮件的本地客户端，推送/拉取邮件
    * 邮件服务器：接收邮件，转发邮件，通知邮件状态
* 协议：基于TCP的SMTP，基于TCP的POP3，客户端/服务器模式
* 格式：
    * 信封
        1. From To（邮箱名@邮箱主机域名）一或多
        1. Subject：主题
        1. Cc：邮件副本
        1. Data：日期
        1. 内容： 纯文本
    * MIME-多用途因特网邮件扩展：数据在7位ascii和非ascii间转换  
    * SMTP-简单邮件传输协议：相互通信的进程交换信息，端口25
        1. 服务器-服务就绪220service ready
        1. 客户端-你好，我是xxx：HELO命令+主机名
        1. 客户端-我有xxx的邮件要发：MAIL from xxx@mail.com
        1. 服务器-好的，到哪（同时确认能不能送）：250 ok，RCPT to xxx@mail.com
        1. 客户端-好的，发正文：DATA
    * POP3-邮局协议：非常简单，功能优先  
    POP3特有的下载并删除
    * IMAP-因特网报文存取协议：更复杂，更多功能  
    邮件分类，预览
### C6.5 万维网 WWW  
一般意义上的网址
* 超媒体：超文本扩展——现代网站，提供文字，图像，音视频
* url：统一资源定位符
    * 格式：<协议>://<主机>:<端口>/<路径>
        1. 协议：ftp，http，news
        1. 主机：存放资源的主机域名
        1. 端口/路径：可省略，http默认80
* http：超文本传输协议
    * 工作过程：服务器持续坚挺TCP端口，如果有请求就建立连接，客户端发送页面请求，服务端返回请求的页面，释放TCP连接
    * 持续连接：http/1.1支持，不会立即释放连接
        * 停止等待协议/流水线
    * 代理服务器：万维网高速缓存，代表服务器返回数据，当然也可以作防火墙
* 页面显示：超文本标记语言 HTML HyperTextMarkup Language
    * 类xml
    * 链接：远程/本地
    * XHTML：更严格的
    * 层叠样式表CSS Cascading Style Sheets
    * 静态/动态文档：被用户申请时在服务器上的表现不同，一个不变一个改变
* 机制扩充：通用网关接口——CGI双方增加一个应用去处理对方的控制
    * 脚本，被其他程序利用
    * 活动文档：直接发给客户端自己用——java
        * 组成：程序语言，运行环境JVM，类库
* 信息检索：搜素引擎
    * 全文搜索（百度，谷歌）分类目录搜索（雅虎，新浪）垂直搜索（特定）
    * 博客（不符国情）
    * 社交网络
* http报文
1. 请求报文
    1. 开始行：方法[空格]URL[空格]版本[\n]
    1. 首部行*n：key:value[\n]  
    1. 实体主体  
1. 响应报文  
    1. 开始行：版本[空格]状态码[空格]短语[\n]
        * 状态码：404
            1. 通知信息的
            1. 成功
            1. 重定向
            1. 客户差错
            1. 服务器差错
    1. 首部行*n：key:value[\n]  
    1. 实体主体
* cookie:服务器和客户之间传递的状态信息,可跟踪