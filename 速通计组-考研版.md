# 速通计算机组成原理-考研版
## 前言：
* 基于王道408-2025版复习资料，**千万不要去z-library上下载盗版**
* 善用LLM
* 对本科老师的吐槽详见原版
## C1 概述（略）
## C2 数据表示与运算
> 暂缓
## C3 存储系统
### 3.1 概述
### 3.2 主存
### 3.3 连接
### 3.4 外存
### 3.5 高速缓存
## C4 指令系统
> 即刻开饭！
### 4.1 指令系统
* ISA（Instruction System Architecture）：一台计算机所有指令集合
    1. 指令格式
    1. 操作数类型与寻址方式
    1. 寄存器编号与位数
    1. 程序执行过程的控制方式
* 基本格式：操作码+N*数据地址
    * 指令字长：一条指令的位数，可以小于机器字长，也可以超过机器字长，但是更耗时
* 指令分类：依据数据地址数量
    1. 0地址：本来就不需要操作数 / 堆栈操作，数据已经压入寄存器
    1. 1地址：结果存回原地址 / 取另一个指令
    1. 2地址：两个输入，输出存回第一个
    1. 3地址：两个输入，指定了输出地址
    1. 4地址：比3地址多了个下一条指令的地址
* 操作码：定长/可变
    * 定长：浪费带宽和寄存器，好在简单且快
    * 变长：浪费一点操作码位数，用于分类操作码类型
* 类型
    1. 数据传递：存储转存
    1. 算数，逻辑运算
    1. 移位操作
### 4.2 寻址方式
* 指令寻址：顺序寻址（PC+1），跳跃寻址（直接给地址/给偏移量）
* 数据寻址：数据存储类型不同，需要寻址特征码。地址也需要转换为真实地址
    1. 隐含寻址：地址在特定的寄存器中，由指令设计时决定
    1. 立即寻址：地址就是操作数
    1. 直接寻址：在主存上-形式地址 == 真实地址
    1. 间接寻址：在主存跳转一次
    1. 寄存器寻址：在寄存器上-形式地址 == 真实地址
    1. 寄存器间接寻址：在寄存器上找到主存的地址
    1. 相对寻址：加上当前程序计数器的值，得到其地址
    1. 基址寻址：加上基址寄存器的值获得其地址
    1. 变址寻址：加上变址寄存器的值获得其地址
        > 以上三个统称为偏移寻址
    1. 堆栈寻址：
        * 栈：硬件设计/软件划分的一片后进先出的存储区 
### 4.3 程序的机器代码表示
* 主要寄存器：  

    | 2Byte | 1Byte | 1Byte |
    | - | - | - |
    | | AH | AL |
    | | BH | BL |
    | | CH | CL |
    | | DH | DL |
    | ESI | ESI | ESI | ESI |
    | EDI | EDI | EDI | EDI |
    | EBP | EBP | EBP | EBP |
    | ESP | ESP | ESP | ESP |

    * 解释：
        1. Accumulator：累加器 Base：基地址寄存器 Count:计数寄存器 Data：数据寄存器
            * 32bit下可以扩展为EAX，EBX，16bit下原名，8bit下可以拆分成AH（High），AL（Low） 
        2. ESI，EDI：变址寄存器（index）
        3. EBP，ESP：堆栈基，堆栈顶指针（Base，Stack）
* 格式：Intel格式
    * 操作数：**to-from**
    * 寄存器(%)立即数($)不需要前缀
    * 数据长度：word（字，16b），dword（双字，32b）
    * <reg16> ：任意1字长寄存器的数据
    * <mem>：内存地址内的数据
    * <con8>：8位常数
    * [var]：var指示内存地址
    * 总共：数据长度+指针+指针地址，常数，
* 指令
    1. mov：复制到目标
    1. push：将操作数压入内存栈
    1. pop：捅出栈，压入操作数地址
    1. add/sub：对应c++的 += 与 -= 
    1. inc/dec：对应c++的 ++ 与 -- 
    1. imul：有符号整数乘法，分为2操作数和3操作数，to必须是寄存器
    1. idiv：有符号整数除法，被除数在edx，除数为操作数
    1. and/or/xor：与/或/异或，结果放在to中
    1. not：位反转，每一位翻转
    1. neg：取负数
    1. shl/shr：逻辑左移/右移
    1. IP：自动指向下一条指令，一般不可操作，但可以用控制流更新
        * jmp：此时操作数代表跳转地址
        * j-condition：根据CPU状态字终端一系列条件状态转移
            1. +e：equal，相等
            1. +z；zero，为0
            1. ne：not equal，不等
            1. jg：greater；大于
            1. jge：greater/equal：大于等于
            1. jl：less：小于
            1. jle：less/equal：小于等于
        * cmp/test：相当于sub指令，但不保存操作结果
        * call/ret：call <label>将当前指令压栈，转移到标签指示的指令，执行完成后再ret捅出栈
            1. P将入口参数(实参)放到Q能访问到的地方。
            1. P将返回地址存到特定的地方，然后将控制转移到Q
            1. Q保存P的现场，并为自己的非静态局部变量分配空间
            1. 执行过程Q
            1. Q恢复P的现场，将返回结果放到P能访问到的地方，并释放局部变量
            1. O 取出返回地址，将控制转移到P
* 循环语句的机器语言：
    1. do-while()
        ```c
        // c语言实现
        do
            do_sth();
            while(condition)
        ```
        ```asm
        loop:
        do_sth
        t = condition;
        if(t)
            goto loop;
        ```
    1. while
        ```c
        while(condition) do_sth();
        
        ```
        ```asm
        t = condition;
        if(!t)
            goto done;
        loop:
        do_sth
        t = condition;
        if(t)
            goto loop;
        done:
        ```
    1. for
        ```c
        // C语言实现
        int nsum_for(int n){
            int i;
            int result = 0;
            for(i=1; i<=n; i++) result +=i;
            return result
        }
        // EZ？
        ```
        ```asm
        #NO EASY
        mov ecx,dword ptr [ebp+8]
        mov eax,0
        mov edx,1
        cmp edx,ecx
        jg .L2
        .L1:
            add eax,edx
            add edx,1
            cmp edx,ecx
            jle ,L1
        .L2:
        ```
### 4.4 CISC与RISC
* Complex Instruction System Computer
    * 指令长度不定长时间不定长，数量多，频率差别大，寻址方式多，微程序，难优化
* Reduced Instruction System Computer
    * 指令长度定长，执行时间定长，数量少，少寻址方式，硬布线控制
## C5 CPU
### 5.1 功能
* 功能：指令控制，操作控制，时间控制，数据加工，中断处理
* 基本结构：运算器（算数逻辑单元，配套的寄存器），控制器（计数器，寄存器，译码器）
    * 通用寄存器：存放操作数，栈
    * 累加寄存器ACC：暂时存放ALU结果
    * 移位寄存器SR：不仅可以存数据，还能移位
    * 暂存寄存器：暂存从总线/通用寄存器的操作数
    * 程序状态寄存器PSW：溢出OF，符号SF，零标志SF，进位标志CF
    ---
    * 程序计数器PC：存储下一条指令的地址
    * 指令寄存器IR：保持当前运行的指令
    * 存储器数据寄存器MDR：存放要与主存交互的信息
### 5.2 执行过程
* 指令周期：取址，取有效地址（定长），执行
* 过程：取址 -> PC+1 -> 间接寻址 -> 执行- -> 中断
    1. **取址：**  
    PC -> MAR --地址总线--> 存储器  
    CU（控制单元）发出读命令 --控制总线--> 存储器  
    主存 --数据总线--> MDR --> IR  
    CU发出控制信号 -> PC++
    1. **间址：**  
    PC -> MAR --地址总线--> 存储器  
    CU（控制单元）发出读命令 --控制总线--> 存储器  
    主存 --数据总线--> MDR
    1. **执行**  
    本章暂不讨论
    1. **中断**：处理中断请求
    SP-1 -> MAR --地址总线--> 存储器  
    CU发出写命令 --控制总线--> 存储器
    PC -> MDR --数据总线--> 主存     # 程序断点存入处理器
    CU（中断服务程序的入口地址） -> PC
* 执行方案：
    * 单周期：即CPI = 1，下一条指令只能在前一条执行结束后才能启动
    * 多周期：即CPI > 1，之零件仍是串行执行
    * 流水线：追求每个时钟周期内完成一条指令执行，通过尽量让多条指令同时进行
        * 超标量流水线：通过重新排序指令执行顺序来尽可能完全使用执行单元
### 5.3 数据通路
* 功能：传递指令与数据
* 组成：
    * 组合逻辑单元：译码器，多路选择器，三态门，不包含记忆单元
    * 时序逻辑元件：各类寄存器，储存器，包含记忆单元
* 结构：
    > 这里应该有一个图片.jpg
    > 大概的意思是所有组件均挂在总线下，由CU控制所有部件的开关
    > 可以使用多总线，一个时钟周期内可以传递更多信息
    > 可以使用专用数据通路，更快，但是更占地
* 过程：指令执行过程的细化：输出端打开out，输入端打开in，其余部件不变
### 5.4 控制器：
* 功能：取指令，下一条指令的地址；指令译码与测试，产生操作控制信号；控制CPU与其他设备的数据流动方向
* 组成
    * 硬布线控制器：操作码译码，通过组合逻辑电路产生控制信号，每个时钟周期发出不同的控制信号
    * 微程序控制器：从ROM/PLA（Programmable Logic Array）中查表，其中也有类似于CPU中的IR和PC
        * 编码方式：
            1. 直接编码，正统查表，直接使用
            1. 字段直接编码，将互斥性微命令编码并放在同一字段中，少一个地址跳转，但是多了译码过程
            1. 字段间接编码：一个微命令由另外一下微命令来解释
        * 地址形成：
            1. 微指令的下地址地段
            1. 机器操作码
            1. 增量计数器
            1. 由标志决定
        * 格式
            1. 水平：上述三种，可并行，编写麻烦
            1. 垂直：操作码+目的地址+源地址，简单且快，不好并行
### 5.5 异常与中断
* 定义：意外时间，即刻响应
* 分类：
    *





## C6 总线
## C7 IO系统

