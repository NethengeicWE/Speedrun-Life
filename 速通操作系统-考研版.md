# 速通操作系统-考研版
## 前言：
* 基于王道408-2025版复习资料，**千万不要去z-library上下载盗版**
* 善用LLM
* 对本科老师的吐槽详见原版

## C1 概述：
### 1.1 定！义！
* 定义：操作系统 (Operating System，OS)是指**控制和管理**整个计算机系统的硬件与软件资源，合理地组织、**调度**计算机的工作与资源的分配，进而为用户和其他软件**提供方便接口与环境**的程序集合。操作系统是计算机系统中最基本的系统软件。
* 特征：
    1. 并发：交替运行多个程序
    1. 共享：并发程序可以使用相同资源
    1. 虚拟：物理定义 -》逻辑定义
    1. 异步：时间不确定，保证相同结果
* 目标：  
    1. 管理：进程，存储器，文件，设备
    1. 接口：命令，程序
### 1.2 发展
* 历程
    1. 裸机，所有管理由人类进行
    1. 单/多批处理系统：
        * 单：逐个执行输入程序
        * 多：并发执行缓存程序
    1. 分时操作系统：多用户，时分复用
    1. 实时操作系统：现时，紧急任务
    1. 网络/分布式操作系统：分布式，并行性
    1. 个人操作系统：win，mac，linux...

### 1.3 运行环境
* 两种不同性质的程序：内核与应用
    > 权限不同：内核可执行特权指令，更底层
    1. 时钟管理：计时的最小单位
    1. 中断：打断当前任务去执行
        * 可以操作内核，通过**自陷**实现
        * 内部中断：程序故障/终止
        * 外部中断：P/S2键盘，可屏蔽
    1. 原语：理解为原子操作，可调用的公用小程序
    1. 系统数据结构管理：进程，存储器，设备管理
    1. 系统调用syscall：设备，文件，内存，进程管理，进程调度

### 1.4 结构
* 分层法：套娃
    * 优点：易调试，易扩充，易维护
    * 缺点：层间管理不佳
* **模块化**：分叉树
    * 内聚和外耦的平衡
* 宏内核：一揽子核心
* 微内核：仅保留核心功能与服务通讯，其余功能移交用户态
    > 保留功能：进程管理，底层存储管理（比如地址变换），中断（转发）
* 外核：虚拟机特有，为虚拟机分配物理资源，避免串味
### 1.5 引导-传统的BIOS（legacy）
1. BIOS：自检，加载引导程序
1. Bootloader：前513B是MBR，负责找到活动分区，进行第二段引导
1. GRUB（Linux）：读取配置文件，调整内核参数，加载linux内核

### 1.6 虚拟机分类
1. 宿主：在windows上开vmware
1. 架空：在windows上开wsl（Hyper-V），PVZ

## C2 进程与线程
### 2.1 定义
* 进程：程序加载到内存后，在CPU执行的过程
* 进程控制块PCB：描述程序和数据的数据结构（表）
    * 存储：
        1. 进程描述信息。进程标识符PID，用户标识符UID
        1. 进程控制和管理信息
        1. 进程优先级
        1. 资源分配清单
        1. 处理机相关信息（CPU上下文）
    * 性质
        * 动态：静止的数据被cpu处理
        * 并发：多个进程存于内存中，能在一段时间内同时运行
        * 独立：进程基本单位
        * 异步：由并发导致的时间不确定
* 程序段，数据段：进程的程序和数据
* 进程状态：
    * 运行态：正在由CPU核心处理
        * 子进程：继承父进程资源，结束时释放资源
    * 就绪态：存储在运存中，随时可运行
    * 阻塞态：等待缺乏运行所需的资源传达，所有资源齐全后进入就绪态
    * 终止态：不再运行，释放占用资源，结束子进程
    * 创建态：正在创建进程
        1. 分配进程标识号，创建PCB
        1. 分配资源：内存，文件，io资源，cpu时间等
        1. 初始化PCB：cpu状态信息和控制信息
* 进程通讯：
    * 共享存储：划分可共享的内存空间，需要同步互斥工具
    * 消息传递：利用操作系统提供的消息传递方法实现通信，分为直接（直达）/间接（转接）
    * 管道通信：特殊的共享文件：一端写一端出，单向传递。在linux中常用，一般会限制大小，如果管道为空则读取命令会导致进程进入阻塞。
* 进程和线程的区别：**一个进程可以包含多个线程**
    * 进程：操作系统层级的程序管理，拥有独立的地址空间，比较庞大
    * 线程：CPU层级的任务管理，共享地址空间，更加灵活，系统线程难以终止      
    线程也有与PCB类似的TCB：标识符，寄存器，优先级，存储区，堆栈指针  
    > * 进程与线程
    > 进程就像是一个公司，每个公司有独立的办公空间（地址空间）和资源（如资金、设备等）。    
    > 线程就像是公司中的员工，员工共享公司的资源，但每个员工有自己的工作任务（栈和寄存器状态）。    
    > * 用户空间与内核空间:  
    > 用户空间就像是普通员工的办公区，员工可以自由工作，但不能直接操作公司的核心设备（硬件资源）。  
    > 内核空间就像是管理层的办公区，管理层可以直接操作公司的核心设备，管理整个公司的运作。
* 线程实现方式：权限不同——用户线程/内核线程
    * 用户级：内核进程使用用户空间线程库，无需模式切换，单独设置进程调度，不依赖操作系统，但一个线程阻塞会影响到整个进程
    * 内核级：小，切换快，内核支持运行，支持多线程，但是同进程下的线程切换开销大
    * 组合方式：综合实现，一个内核线程通过时分复用控制多个用户线程（后文提及）
* 多线程模型：
    * 一对多：一内核多用户，调度管理在用户，但是访问内核时会出现阻塞
    * 一对一：一内核一用户，调度在内核，无阻塞，高并发，但是内核开销大
    * 多对多：少量内核多个用户：综合上述优点
### 2.2 调度
* 定义：将算法高效分配给CPU进行运行
* 调度层次
    1. 高级调度（作业调度）：内存与存储
    1. 中级调度（内存调度）：将暂时不运行的进程挂起，具备运行条件且内存有空闲时再调入内存
    1. 低级调度（进程调度）：从就绪序列中选取一个进程分配给cpu运行
* 调度器：
    * 排队器：就绪进程通过排队器插入就绪队列
    * 分配器：从队列中取出进程，分配给CPU
    * 上下文切换器：切换进程---保存进程上下文至PCB，装入新的上下文
        * 装填寄存器及其费时，故设计两套计时器：内核与用户
* 调度操作：
    * 时机：新线程创建，进程结束/终止，进程被阻塞，中断。  
    高优先级强行剥夺，时间片耗尽
    * 不能调度：中断处理，完全屏蔽中断的原子操作
    * 方式：抢占/非抢占调度
    * 闲逛进程：就绪队列为空时运行
    * 用户/内核进程：
        * 用户进程：对内核透明，内核选择一个进程，给与时间控制，由调度程序决定。  
        线程切换是在同一进程中。仅需少量机器指令
        * 内核进程：选择一个特定线程执行，给予时间片，时间片结束强行剥夺  
        完整的上下文切换，修改内存块和高速缓存，详见[速通计组-考研版](./速通计组-考研版.md#35-高速缓存)
    * 目标：多种标准
        > **我爸得了M⬆ V➡P⬇！**
        * CPU利用率：有效工作时间/有效+空闲时间
        * 系统吞吐量：单位时间完成的作业数量
        * 周转时间：作业完成时间-作业提交时间
            * 平均周转时间：多个作业周转时间平均值
            * 加权平均周转时间：权重为 $\frac{周转时间}{运行时间}$
        * 等待时间：进程等待被执行的时间
        * 响应时间：用户提交请求到系统响应的时间
* 进程切换-上下文切换：
    * 定义：保存当前进程状态，恢复另一个进程状态
    * 流程：
        1. 挂起一个进程，CPU上下文保存到PCB
        1. 进程PCB移入其他等待队列
        1. 选择一个程序执行，更新PCB
        1. 恢复新进程的上下文
        1. 跳转到新进程PCB的程序计数器继续执行
    * 消耗：使用可观的CPU时间，如果设置多个寄存器则只用改变指针
    * 模式切换：CPU在运行内核态和用户态线程的切换
* 典型调度算法：
    * 先来先服务FCFS：不可剥夺，公平作业
        * 等待时间不佳
    * 短作业有限SJF：优先运行-运行时间最短的作业
        * 对长作业不公，可能会饿死
    * 高响应比调度：综合上述两种操作，优先执行响应比高的作业
        * 响应比：$R_p = \frac{等待时间+要求服务时间}{要求服务时间}$
    * 优先级调度：根据人工设定的优先级，高优先级优先调度
        > 回想缺氧的调度，合理调度能最大化生产效率，减少周转时间
        * 适用于存储调度和进程调度
        * 抢占/非抢占：等待队列中出现了比正在执行的作业更高的优先级，是否立即切换
        * 动态/静态优先级：创建进程时确定/随进程执行或等待时间
        * IO型/计算型：io设备的处理速度比CPU慢，高优先级的io进程能尽快使得io设备工作
    * 时间片轮转：分时系统
        * 就绪进程按照FCFS策略排序，每个就绪进程都能分得一定时间执行
        * 频繁的上下文切换，小号新年
    * 多级队列调度：多个就绪队列，根据类型和性质分配，可执行不同的调度算法
    * 多级反馈队列调度：时间片+优先级调度
        * 多个优先级不同，时间片不同的FCFS队列
        * 如果未能在时间片内完成，调入下一级队列
        * CPU优先运行高优先级队列

### 2.3 同步与互斥
* 基本概念：
    * 缘由：并发进程有着不同的制约关系，存在只能一个人用的临界资源
    * 同步：多个进程间的相互合作
    * 互斥：临界资源被使用时阻止其他人的访问
    * 准则：空闲让进，忙则等待，有限等待，让权等待
* 实现方法：
    * 单标志法：设置公用变量标记是否占用，但只能阻止不能通知
        * 有限等待未完成
    * 双标志先检查：设置额外的变量，先检查对方，再设置自己的。都想要那就打一架
        * 互斥，有限等待
        * 实现复杂，仅两个线程
    * 双标志后检查：设置额外的变量，先设置自己，后检查对方。都想要那就打一架
        * 互斥，不能有限等待
    * Peterson：两个标志变量，一个竞争变量
        * 由竞争变量决定冲突时哪个先上
    * 硬件实现：
        * 中断屏蔽：进入临界区关闭中断，避免不存在的逻辑
        * 硬件TestAndSend：原子操作，读出标志并设置为真
        * 硬件Swap：交换两字节内容
        